<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>æ¸…å•Plus Â· æˆ‘çš„â¼€å¤©</title>
<meta name="theme-color" content="#0f1221" />
<style>
  :root{
    --bg:#0f1221;
    --panel:#141831;
    --muted:#a7b0d4;
    --text:#e9edff;
    --accent:#6d8bff;
    --accent-2:#9b72ff;
    --chip:#1a1f3f;
    --chip-hover:#23294f;
    --ok:#32d27d;
    --warn:#ffbd2f;
    --danger:#ff5a6b;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
    --radius:16px;
  }
  html.light{
    --bg:#f6f8ff;
    --panel:#ffffff;
    --muted:#6b7598;
    --text:#0f1221;
    --accent:#4662ff;
    --accent-2:#6c4bff;
    --chip:#eef2ff;
    --chip-hover:#e4e9ff;
    --shadow: 0 10px 30px rgba(22,29,64,.10);
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font: 15px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
  }
  /* Shell */
  .app{
    max-width:1100px; margin-inline:auto; padding:14px 10px 88px;
  }
  .topbar{
    display:flex; align-items:center; gap:12px; margin:6px 0 14px;
  }
  .brand{
    display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.3px;
  }
  .logo{
    width:34px; height:34px; border-radius:10px;
    background: radial-gradient(120% 120% at 10% 10%, var(--accent), var(--accent-2));
    box-shadow: 0 6px 16px rgba(77,99,255,.35);
  }
  .grow{flex:1}
  .moon{
    display:inline-flex; align-items:center; justify-content:center;
    width:40px; height:40px; border-radius:12px; background:var(--panel);
    color:var(--muted); border:1px solid rgba(255,255,255,.06);
    box-shadow: var(--shadow); cursor:pointer; transition:.2s transform;
  }
  .moon:active{ transform: scale(.98); }

  /* Grid */
  .grid{
    display:grid; grid-template-columns: 240px 1fr; gap:16px;
  }
  @media (max-width:900px){
    .grid{ grid-template-columns: 1fr; }
  }

  /* Sidebar */
  .side{
    background:var(--panel); border-radius:var(--radius);
    border:1px solid rgba(255,255,255,.06); box-shadow:var(--shadow);
    padding:14px;
    position:sticky; top:10px; height:max-content;
  }
  .side h4{margin:6px 6px 10px; color:var(--muted); font-weight:700; font-size:12px; letter-spacing:.6px}
  .nav{ display:flex; flex-direction:column; gap:6px; }
  .nav button{
    all:unset; display:flex; align-items:center; justify-content:space-between;
    padding:12px 12px; border-radius:12px; cursor:pointer;
    background:transparent; color:var(--text); border:1px solid transparent;
  }
  .nav button:hover{ background:var(--chip-hover); }
  .nav button.active{
    background:var(--chip); border-color:rgba(255,255,255,.08);
    outline: 1.5px solid color-mix(in oklab, var(--accent) 60%, transparent);
  }
  .count{ color:var(--muted); font-weight:700; font-size:12px; }

  /* Board */
  .board{
    background:var(--panel); border-radius:var(--radius);
    border:1px solid rgba(255,255,255,.06); box-shadow:var(--shadow);
    padding:14px;
  }
  .chips{ display:flex; gap:8px; flex-wrap:wrap; margin:4px 0 12px; }
  .chip{
    padding:8px 12px; border-radius:999px; background:var(--chip); color:var(--text);
    border:1px solid rgba(255,255,255,.06); cursor:pointer; transition:.2s;
    font-weight:700; font-size:12px;
  }
  .chip:hover{ background:var(--chip-hover) }
  .chip.active{
    background:linear-gradient(90deg, var(--accent), var(--accent-2));
    border-color:transparent;
  }

  /* Tasks list */
  .list{ display:flex; flex-direction:column; gap:10px; }
  .item{
    display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center;
    background:rgba(255,255,255,.02); border:1px solid rgba(255,255,255,.06);
    padding:10px 12px; border-radius:14px;
  }
  .item.done{ opacity:.55; }
  .check{ width:20px; height:20px; accent-color: var(--accent); cursor:pointer; }
  .title{
    display:flex; flex-direction:column; gap:3px;
  }
  .title input{
    all:unset; color:var(--text); font-weight:700; letter-spacing:.2px;
  }
  .meta{
    color:var(--muted); font-size:12px; display:flex; gap:10px; align-items:center;
  }
  .badge{ padding:2px 8px; border-radius:999px; background:var(--chip); border:1px solid rgba(255,255,255,.06) }
  .actions{ display:flex; gap:8px; align-items:center; }
  .btn-ghost{
    all:unset; padding:8px 10px; border-radius:10px; cursor:pointer; color:var(--muted);
    border:1px solid rgba(255,255,255,.06); background:transparent;
  }
  .btn-ghost:hover{ color:var(--text); background:var(--chip-hover) }
  .rating{ display:flex; gap:2px; }
  .star{
    width:18px; height:18px; cursor:pointer; display:inline-block;
    -webkit-mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path d="M12 2.5 9.7 8H4l4.6 3.4L6.7 17l5.3-3.3 5.3 3.3-1.9-5.6L19.9 8h-5.7L12 2.5z" fill="%23000"/></svg>') center/contain no-repeat;
    background: linear-gradient(90deg, #ffd057, #ffac33);
    opacity:.35;
  }
  .star.on{ opacity:1 }

  /* Composer (moved to bottom) */
  .composer{
    position: fixed; left:0; right:0; bottom:0; z-index:10;
    background:linear-gradient(to top, color-mix(in oklab, var(--bg) 100%, transparent), transparent 30%);
    padding:16px 10px 18px;
  }
  .composer .wrap{
    max-width:1100px; margin:0 auto; background:var(--panel); border-radius:18px;
    border:1px solid rgba(255,255,255,.06); box-shadow:var(--shadow);
    padding:12px;
  }
  .row{
    display:grid; grid-template-columns: 1fr auto auto auto 100px; gap:10px; align-items:center;
  }
  @media (max-width:900px){
    .row{ grid-template-columns: 1fr 120px 100px 90px 84px; }
  }
  @media (max-width:560px){
    .row{ grid-template-columns: 1fr 120px 90px 90px; }
    .repeat{ grid-column: 1 / -2; }
  }
  .field{
    background:var(--chip); border:1px solid rgba(255,255,255,.06); border-radius:12px;
    padding:10px 12px; color:var(--text); width:100%;
  }
  input[type="date"], input[type="time"], select{
    background:var(--chip); border:1px solid rgba(255,255,255,.06); border-radius:12px;
    padding:10px 12px; color:var(--text); width:100%;
  }
  .add{
    all:unset; text-align:center; background:linear-gradient(90deg, var(--accent), var(--accent-2));
    padding:12px 14px; border-radius:12px; color:#fff; font-weight:800; cursor:pointer;
  }

  /* helpers */
  .hidden{ display:none !important; }
  .muted{ color:var(--muted); }
</style>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div style="display:flex;flex-direction:column">
          <div style="font-weight:900; letter-spacing:.2px">æ¸…å•Plus</div>
          <small class="muted" style="margin-top:-2px">è®°å½• Â· æé†’ Â· ä¸“æ³¨</small>
        </div>
      </div>
      <div class="grow"></div>
      <button class="moon" id="themeBtn" aria-label="åˆ‡æ¢ä¸»é¢˜" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
    </header>

    <div class="grid">
      <!-- LEFT: Filters (kept only required ones) -->
      <aside class="side">
        <h4>è§†å›¾</h4>
        <div class="nav" id="filterNav">
          <button data-filter="all" class="active"><span>å…¨éƒ¨</span><span class="count" id="cAll">0</span></button>
          <button data-filter="today"><span>ä»Šå¤©</span><span class="count" id="cToday">0</span></button>
          <button data-filter="important"><span>é‡è¦</span><span class="count" id="cImportant">0</span></button>
          <button data-filter="done"><span>å·²å®Œæˆ</span><span class="count" id="cDone">0</span></button>
          <button data-filter="todo"><span>æœªå®Œæˆ</span><span class="count" id="cTodo">0</span></button>
        </div>
      </aside>

      <!-- RIGHT: Task board -->
      <main class="board">
        <!-- quick chips -->
        <div class="chips" id="quickChips">
          <button class="chip" data-chip="today">ä»Šå¤©</button>
          <button class="chip" data-chip="tomorrow">æ˜å¤©</button>
          <button class="chip" data-chip="mon">å‘¨ä¸€</button>
          <button class="chip" data-chip="tue">å‘¨äºŒ</button>
          <button class="chip" data-chip="wed">å‘¨ä¸‰</button>
          <button class="chip" data-chip="thu">å‘¨å››</button>
          <button class="chip" data-chip="fri">å‘¨äº”</button>
          <button class="chip" data-chip="sat">å‘¨å…­</button>
          <button class="chip" data-chip="sun">å‘¨æ—¥</button>
          <button class="chip" data-chip="week">æœ¬å‘¨</button>
          <button class="chip" data-chip="month">æœ¬æœˆ</button>
          <span class="chip muted" style="cursor:default">ç‚¹å‡»å¿«é€Ÿè®¾ç½®æ—¥æœŸ</span>
        </div>

        <!-- List -->
        <div class="list" id="taskList"></div>

        <!-- Empty state -->
        <p id="emptyTip" class="muted" style="text-align:center;margin:30px 0 10px;">æ²¡æœ‰ä»»åŠ¡ã€‚åˆ°åº•éƒ¨æ·»åŠ æ–°ä»»åŠ¡ï½</p>
      </main>
    </div>
  </div>

  <!-- Composer at bottom -->
  <div class="composer">
    <div class="wrap">
      <div class="row">
        <input id="taskInput" class="field" placeholder="è¾“å…¥ä»»åŠ¡ï¼ˆä¾‹å¦‚ï¼šå®Œæˆä½œä¸š / ä¹°èœ / å¤ä¹ ï¼‰" />
        <input id="dateInput" type="date" />
        <input id="timeInput" type="time" />
        <select id="repeatInput" class="repeat">
          <option value="none">ä¸é‡å¤</option>
          <option value="daily">æ¯å¤©</option>
          <option value="weekly">æ¯å‘¨</option>
          <option value="monthly">æ¯æœˆ</option>
          <option value="yearly">æ¯å¹´</option>
        </select>
        <button id="addBtn" class="add">æ·»åŠ </button>
      </div>
    </div>
  </div>

<script>
/* -------------- State -------------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

const STORAGE_KEY = "qingdan-plus-tasks-v3";
let tasks = load();
let currentFilter = 'all';

function uid(){ return (Date.now().toString(36)+Math.random().toString(36).slice(2,7)); }
function todayStr(d=new Date()){ return d.toISOString().slice(0,10); }
function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

/* -------------- Theme -------------- */
const themeBtn = $('#themeBtn');
themeBtn.addEventListener('click', () => {
  document.documentElement.classList.toggle('light');
  localStorage.setItem('theme', document.documentElement.classList.contains('light')?'light':'dark');
  themeBtn.textContent = document.documentElement.classList.contains('light') ? 'ğŸŒ' : 'ğŸŒ™';
});
(function initTheme(){
  const t = localStorage.getItem('theme');
  if (t==='light') { document.documentElement.classList.add('light'); themeBtn.textContent='ğŸŒ';}
})();

/* -------------- Load/Save -------------- */
function load(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
  catch(e){ return []; }
}
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks)); }

/* -------------- Render -------------- */
function render(){
  const list = $('#taskList');
  list.innerHTML = '';

  const visible = tasks.filter(t => {
    if (currentFilter==='today') return t.date === todayStr();
    if (currentFilter==='important') return t.star >= 4 && !t.done;
    if (currentFilter==='done') return t.done;
    if (currentFilter==='todo') return !t.done;
    return true; // all
  }).sort((a,b) => {
    // order: not done -> soonest date -> highest star
    const ad = a.done ? 1 : 0, bd = b.done ? 1 : 0;
    if (ad!==bd) return ad - bd;
    const at=a.date||'9999-99-99', bt=b.date||'9999-99-99';
    if (at!==bt) return at.localeCompare(bt);
    return (b.star||0)-(a.star||0);
  });

  visible.forEach(t => list.appendChild(row(t)));

  $('#emptyTip').classList.toggle('hidden', !!visible.length);
  updateCounts();
}
function row(task){
  const el = document.createElement('div');
  el.className = 'item'+(task.done?' done':'');
  el.dataset.id = task.id;

  const done = document.createElement('input');
  done.type='checkbox'; done.className='check'; done.checked=task.done;
  done.addEventListener('change', ()=>{
    task.done = done.checked; save(); render();
  });

  const titleBox = document.createElement('div');
  titleBox.className='title';
  const title = document.createElement('input');
  title.value = task.title;
  title.placeholder='æœªå‘½åä»»åŠ¡â€¦';
  title.addEventListener('change', ()=>{ task.title = title.value.trim(); save(); render(); });

  const meta = document.createElement('div');
  meta.className='meta';
  if (task.date) meta.appendChild(badge('ğŸ“… '+task.date));
  if (task.time) meta.appendChild(badge('â° '+task.time));
  if (task.repeat && task.repeat!=='none'){
    const repMap = {daily:'æ¯å¤©',weekly:'æ¯å‘¨',monthly:'æ¯æœˆ',yearly:'æ¯å¹´'};
    meta.appendChild(badge('ğŸ” '+(repMap[task.repeat]||'é‡å¤')));
  }
  if (task.star>0) meta.appendChild(badge('â­ '+task.star));

  titleBox.append(title, meta);

  const actions = document.createElement('div');
  actions.className='actions';

  // rating
  const rating = document.createElement('div'); rating.className='rating';
  for(let i=1;i<=5;i++){
    const s = document.createElement('i'); s.className='star'+(i<=task.star?' on':''); s.title=i+' æ˜Ÿ';
    s.addEventListener('click', ()=>{ task.star=i; save(); render(); });
    rating.appendChild(s);
  }
  actions.appendChild(rating);

  // edit date/time quickly
  const editBtn = document.createElement('button');
  editBtn.className='btn-ghost'; editBtn.textContent='ç¼–è¾‘';
  editBtn.addEventListener('click', () => quickEdit(task));
  actions.appendChild(editBtn);

  const del = document.createElement('button');
  del.className='btn-ghost'; del.style.color='var(--danger)'; del.textContent='åˆ é™¤';
  del.addEventListener('click', ()=>{
    tasks = tasks.filter(x=>x.id!==task.id); save(); render();
  });
  actions.appendChild(del);

  el.append(done, titleBox, actions);
  return el;
}
function badge(text){ const b=document.createElement('span'); b.className='badge'; b.textContent=text; return b; }

function updateCounts(){
  $('#cAll').textContent = tasks.length;
  $('#cToday').textContent = tasks.filter(t=>t.date===todayStr()).length;
  $('#cImportant').textContent = tasks.filter(t=>t.star>=4 && !t.done).length;
  $('#cDone').textContent = tasks.filter(t=>t.done).length;
  $('#cTodo').textContent = tasks.filter(t=>!t.done).length;
}

/* -------------- Filters -------------- */
$('#filterNav').addEventListener('click', e=>{
  const btn = e.target.closest('button[data-filter]'); if(!btn) return;
  currentFilter = btn.dataset.filter;
  $$('#filterNav button').forEach(b=>b.classList.toggle('active', b===btn));
  render();
});

/* -------------- Quick chips -------------- */
const chips = $('#quickChips');
chips.addEventListener('click', (e)=>{
  const btn = e.target.closest('.chip[data-chip]'); if(!btn) return;
  const now = new Date();
  const map = {
    today: todayStr(now),
    tomorrow: todayStr(addDays(now,1)),
    mon: dateOfWeek(1), tue: dateOfWeek(2), wed: dateOfWeek(3),
    thu: dateOfWeek(4), fri: dateOfWeek(5), sat: dateOfWeek(6), sun: dateOfWeek(0),
    week: todayStr(now), month: todayStr(now)
  };
  const ds = map[btn.dataset.chip];
  if (ds){ $('#dateInput').value = ds; flash(btn); }
});
function dateOfWeek(w){ // 0=Sun..6
  const d=new Date(); const diff = w - d.getDay();
  return todayStr(addDays(d, diff>=0?diff:diff+7));
}
function flash(el){ el.classList.add('active'); setTimeout(()=>el.classList.remove('active'), 500); }

/* -------------- Composer -------------- */
$('#addBtn').addEventListener('click', addTask);
$('#taskInput').addEventListener('keydown', e=>{
  if(e.key==='Enter'){ addTask(); }
});

function addTask(){
  const title = $('#taskInput').value.trim();
  if(!title){ $('#taskInput').focus(); return; }
  const date = $('#dateInput').value || '';
  const time = $('#timeInput').value || '';
  const repeat = $('#repeatInput').value;

  const t = {
    id: uid(),
    title, date, time, repeat,
    star: 0, done:false,
    createdAt: Date.now()
  };
  tasks.push(t);
  save();
  $('#taskInput').value='';
  render();
  // smart repeat creation (next instance) happens on completion not on add
}

/* -------------- Quick edit -------------- */
function quickEdit(task){
  const nd = prompt('è®¾ç½®æ—¥æœŸ (YYYY-MM-DD)ï¼š', task.date||todayStr());
  if (nd===null) return;
  const nt = prompt('è®¾ç½®æ—¶é—´ (HH:MM)ï¼š', task.time||'');
  if (nt===null) return;
  task.date = (nd||'').slice(0,10);
  task.time = (nt||'').slice(0,5);
  save(); render();
}

/* -------------- Repeat handling on complete -------------- */
function handleRepeat(task){
  if(task.repeat==='none') return;
  const cur = task.date ? new Date(task.date+'T00:00:00') : new Date();
  let next = new Date(cur);
  if(task.repeat==='daily') next.setDate(cur.getDate()+1);
  if(task.repeat==='weekly') next.setDate(cur.getDate()+7);
  if(task.repeat==='monthly') next.setMonth(cur.getMonth()+1);
  if(task.repeat==='yearly') next.setFullYear(cur.getFullYear()+1);
  tasks.push({
    id: uid(), title: task.title, date: todayStr(next), time: task.time||'',
    repeat: task.repeat, star: task.star, done:false, createdAt: Date.now()
  });
}

/* Intercept checkbox completion to spawn next repeated task */
document.addEventListener('change', (e)=>{
  if(!e.target.classList.contains('check')) return;
  const id = e.target.closest('.item')?.dataset.id;
  const t = tasks.find(x=>x.id===id);
  if (t && e.target.checked) handleRepeat(t);
  save(); render();
});

/* -------------- Init -------------- */
render();
</script>
</body>
</html>

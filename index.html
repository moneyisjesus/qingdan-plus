<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#0b1020" />
<title>æ¸…å•Plus Â· æˆ‘çš„â¼€å¤©</title>
<style>
  :root{
    --bg:#0b1020; --panel:#111730; --muted:#1a2140; --ink:#e9edff;
    --sub:#a9b0d2; --brand:#6ea8ff; --chip:#243056; --accent:#8bd0ff;
    --ok:#00d08f; --warn:#ffbe5c; --danger:#ff6b6b; --line:#1f2a4d;
    --shadow: 0 8px 24px rgba(8,12,28,.38);
    --radius: 14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);font:16px/1.4 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
    -webkit-tap-highlight-color:transparent;
  }
  /* é¡¶éƒ¨ */
  .appbar{
    position:sticky;top:0;z-index:30;
    background:linear-gradient(180deg,#0b1020 0%, #0b1020dd 70%, transparent 100%);
    padding:12px 16px 10px;backdrop-filter:saturate(140%) blur(8px);
  }
  .row{display:flex;align-items:center;gap:10px}
  .space{flex:1}
  .title{font-size:22px;font-weight:700;letter-spacing:.5px}
  .pill{
    background:var(--muted);border-radius:999px;padding:8px 14px;color:var(--ink);font-weight:600;cursor:pointer;user-select:none;
  }
  .pill.ghost{background:var(--chip);color:#cfe0ff}
  .iconbtn{width:36px;height:36px;border-radius:10px;background:var(--muted);display:grid;place-items:center;color:#cfe0ff}
  .icon{font-size:18px}
  /* è¾“å…¥åŒº */
  .panel{
    background:var(--panel);box-shadow:var(--shadow);border-radius:var(--radius);padding:12px;margin:10px 16px 0
  }
  .input{
    background:var(--muted);border:none;color:var(--ink);border-radius:12px;padding:12px 14px;width:100%;outline:none;font-size:15px;
  }
  .chips{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .chip{border-radius:999px;background:var(--chip);color:#d5e2ff;padding:8px 12px;font-size:13px}
  .filters{display:flex;gap:8px;align-items:center;margin-top:10px}
  .ctrl{
    flex:1;min-width:0;background:var(--muted);border:1px solid var(--line);color:var(--ink);border-radius:12px;padding:8px 10px;font-size:13px;
  }
  .add{background:var(--brand);color:#02122e;border:none;border-radius:12px;padding:10px 14px;font-weight:700}
  .add:active{transform:translateY(1px)}
  /* åˆ—è¡¨ */
  .section{margin:12px 16px}
  .sec-title{color:var(--sub);font-size:12px;letter-spacing:.2px;margin:6px 2px}
  .card{
    background:var(--panel);border-radius:14px;box-shadow:var(--shadow);overflow:hidden
  }
  .task{
    display:flex;gap:10px;align-items:flex-start;padding:12px;border-bottom:1px solid var(--line)
  }
  .task:last-child{border-bottom:none}
  .check{
    width:24px;height:24px;border-radius:50%;border:2px solid #6f89c9;display:grid;place-items:center;cursor:pointer;flex:0 0 auto;
  }
  .check.done{background:var(--ok);border-color:var(--ok);color:#011}
  .t-main{flex:1;min-width:0}
  .t-title{font-weight:700;word-break:break-word}
  .t-meta{color:#a9b0d2;font-size:12px;margin-top:4px;display:flex;gap:8px;flex-wrap:wrap}
  .t-actions{display:flex;gap:8px}
  .tag{background:var(--chip);border-radius:999px;padding:4px 8px;font-size:12px;color:#cfe0ff}
  .star{color:#ffdc7d}
  .danger{color:var(--danger)}
  /* åº•éƒ¨å¯¼èˆª */
  .tabbar{
    position:sticky;bottom:0;z-index:30;background:rgba(11,16,32,.8);
    backdrop-filter:saturate(140%) blur(8px);
    border-top:1px solid var(--line)
  }
  .tabs{display:grid;grid-template-columns:repeat(4,1fr)}
  .tab{
    padding:10px 6px;display:grid;place-items:center;color:#cfe0ff;gap:4px
  }
  .tab.active{color:#8bd0ff}
  .tab .icon{font-size:18px}
  .container{max-width:520px;margin:0 auto}
  /* å°å±ä¼˜åŒ– */
  @media (min-width:461px){
    .appbar{padding-left:24px;padding-right:24px}
    .panel,.section{margin-left:24px;margin-right:24px}
  }
</style>
</head>
<body>
<div class="container">
  <!-- é¡¶éƒ¨ -->
  <header class="appbar">
    <div class="row">
      <div class="iconbtn" aria-label="åº”ç”¨å›¾æ ‡"><span class="icon">ğŸ±â€ğŸ‘“</span></div>
      <div class="title">æ¸…å•Plus</div>
      <div class="space"></div>
      <button class="iconbtn" id="btnBell" title="æé†’">
        <span class="icon">ğŸ””</span>
      </button>
      <button class="iconbtn" id="btnSettings" title="è®¾ç½®">
        <span class="icon">âš™ï¸</span>
      </button>
    </div>

    <div class="panel">
      <input id="taskInput" class="input" placeholder="æ·»åŠ ä»»åŠ¡â€¦" />
      <div class="chips" style="margin-top:10px">
        <button class="chip" data-quick="today">ä»Šå¤©</button>
        <button class="chip" data-quick="tomorrow">æ˜å¤©</button>
        <button class="chip" data-quick="nextMonday">ä¸‹å‘¨ä¸€</button>
        <button class="chip" data-quick="am9">ä¸Šåˆ9:00</button>
        <button class="chip" data-quick="pm3">ä¸‹åˆ3:00</button>
      </div>
      <div class="filters">
        <input id="date" type="date" class="ctrl" />
        <input id="time" type="time" class="ctrl" />
        <select id="priority" class="ctrl">
          <option value="0">ä¼˜å…ˆçº§ï¼šæ— </option>
          <option value="1">â­</option>
          <option value="2">â­â­</option>
          <option value="3">â­â­â­</option>
        </select>
        <select id="repeat" class="ctrl" style="flex:1.2">
          <option value="none">ä¸é‡å¤</option>
          <option value="daily">æ¯å¤©</option>
          <option value="workdays">å·¥ä½œæ—¥</option>
          <option value="weekly">æ¯å‘¨</option>
          <option value="monthly">æ¯æœˆ</option>
        </select>
        <button id="addBtn" class="add">æ·»åŠ </button>
      </div>
    </div>
  </header>

  <!-- ä»Šæ—¥åˆ—è¡¨ -->
  <section class="section">
    <div class="sec-title">æˆ‘çš„ä¸€å¤©</div>
    <div id="list" class="card"></div>
  </section>

  <!-- å…¶ä»–åˆ—è¡¨ï¼ˆé€šè¿‡åº•éƒ¨åˆ‡æ¢ï¼‰ -->
  <section class="section" id="emptyHint" style="display:none;color:#a9b0d2">æš‚æ— å†…å®¹</section>

  <!-- åº•éƒ¨å¯¼èˆª -->
  <nav class="tabbar">
    <div class="tabs">
      <button class="tab active" data-tab="inbox">
        <span class="icon">ğŸ“…</span><small>æˆ‘çš„ä¸€å¤©</small>
      </button>
      <button class="tab" data-tab="important">
        <span class="icon">â­</span><small>é‡è¦</small>
      </button>
      <button class="tab" data-tab="planned">
        <span class="icon">ğŸ—“ï¸</span><small>è®¡åˆ’</small>
      </button>
      <button class="tab" data-tab="all">
        <span class="icon">âœ…</span><small>ä»»åŠ¡</small>
      </button>
    </div>
  </nav>
</div>

<script>
/* ------------ æ•°æ®ä¸å·¥å…· ------------- */
const storeKey='qdplus_tasks_v1';
const $=s=>document.querySelector(s);
const $$=s=>document.querySelectorAll(s);
const fmt=(d)=>d?new Date(d):null;
const todayStr=()=>new Date().toISOString().slice(0,10);
const nextMonday=()=>{
  const d=new Date(); const day=d.getDay()||7; // 1..7
  const diff=8-day; d.setDate(d.getDate()+diff);return d.toISOString().slice(0,10);
};
const setAtTime=(dateISO,hhmm)=>{
  if(!dateISO) return null;
  const d=new Date(dateISO);
  if(hhmm){
    const [h,m]=hhmm.split(':').map(Number);
    d.setHours(h,m,0,0);
  }
  return d.toISOString();
}
let tasks=JSON.parse(localStorage.getItem(storeKey)||'[]');

/* ------------ æ¸²æŸ“ ------------- */
let currentTab='inbox'; // inbox/important/planned/all
const listEl=$("#list"), emptyHint=$("#emptyHint");

function badge(t){
  const bits=[];
  if(t.date){
    const ds=new Date(t.date);
    bits.push(`<span class="tag">ğŸ“… ${ds.toLocaleDateString()}</span>`);
  }
  if(t.time){
    bits.push(`<span class="tag">â° ${t.time}</span>`);
  }
  if(t.repeat!=='none'){
    const map={daily:"æ¯å¤©",workdays:"å·¥ä½œæ—¥",weekly:"æ¯å‘¨",monthly:"æ¯æœˆ"};
    bits.push(`<span class="tag">ğŸ” ${map[t.repeat]||t.repeat}</span>`);
  }
  if(t.priority>0){
    bits.push(`<span class="tag">â­`.padEnd(4+t.priority,'â­')+`</span>`);
  }
  return bits.join('');
}
function filterByTab(arr){
  const today=todayStr();
  if(currentTab==='inbox') return arr.filter(t=>t.date===today || (!t.date && !t.done));
  if(currentTab==='important') return arr.filter(t=>t.priority>0 && !t.done);
  if(currentTab==='planned') return arr.filter(t=>t.date && !t.done);
  return arr; // all
}
function render(){
  const data=filterByTab(tasks).sort((a,b)=>{
    // æ’åºï¼šæœªå®Œæˆ>å·²å®Œæˆï¼›ä¼˜å…ˆçº§ï¼›æ—¥æœŸæ—¶é—´
    if(a.done!==b.done) return a.done?1:-1;
    if(b.priority!==a.priority) return b.priority-a.priority;
    return (a.date||'').localeCompare(b.date||'') || (a.time||'').localeCompare(b.time||'');
  });
  listEl.innerHTML = data.map(t=>`
    <div class="task" data-id="${t.id}">
      <button class="check ${t.done?'done':''}" title="å®Œæˆ">${t.done?'âœ“':''}</button>
      <div class="t-main">
        <div class="t-title">${escapeHTML(t.title)}</div>
        <div class="t-meta">${badge(t)}</div>
      </div>
      <div class="t-actions">
        <button class="iconbtn star" data-act="star" title="æ ‡ä¸ºé‡è¦">â­</button>
        <button class="iconbtn danger" data-act="del" title="åˆ é™¤">ğŸ—‘ï¸</button>
      </div>
    </div>
  `).join('');
  emptyHint.style.display=data.length?'none':'block';
}
function escapeHTML(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}

function save(){ localStorage.setItem(storeKey,JSON.stringify(tasks)); render(); }

/* ------------ æ·»åŠ  / å¿«æ· ------------- */
$("#addBtn").addEventListener('click', addTask);
$("#taskInput").addEventListener('keydown', e=>{if(e.key==='Enter') addTask();});

function addTask(){
  const title=$("#taskInput").value.trim();
  const date=$("#date").value||null;
  const time=$("#time").value||null;
  const priority=parseInt($("#priority").value,10)||0;
  const repeat=$("#repeat").value;
  if(!title){ $("#taskInput").focus(); return; }
  const id=Date.now().toString(36)+Math.random().toString(36).slice(2);
  const iso=setAtTime(date,time);
  tasks.push({id,title,date, time, priority, repeat, done:false, notifyAt: iso});
  save();
  notifySchedule();
  clearInputs();
}
function clearInputs(){
  $("#taskInput").value='';
  $("#date").value=''; $("#time").value='';
  $("#priority").value='0'; $("#repeat").value='none';
}
$$('.chip').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const k=btn.dataset.quick;
    if(k==='today') $("#date").value = todayStr();
    if(k==='tomorrow'){ const d=new Date(); d.setDate(d.getDate()+1); $("#date").value=d.toISOString().slice(0,10); }
    if(k==='nextMonday') $("#date").value = nextMonday();
    if(k==='am9') $("#time").value='09:00';
    if(k==='pm3') $("#time").value='15:00';
  });
});

/* ------------ åˆ—è¡¨äº¤äº’ ------------- */
listEl.addEventListener('click', e=>{
  const task = e.target.closest('.task'); if(!task) return;
  const id   = task.dataset.id;
  const t    = tasks.find(x=>x.id===id);
  if(e.target.classList.contains('check')){
    t.done = !t.done;
    if(t.done){ t.notifyAt=null; } // å®Œæˆå°±ä¸æé†’
    save(); return;
  }
  const act = e.target.closest('[data-act]')?.dataset.act;
  if(act==='star'){
    t.priority = t.priority===0 ? 2 : 0; // ç‚¹ä¸€ä¸‹è®¾ä¸­ç­‰æ˜Ÿï¼Œå†ç‚¹å–æ¶ˆ
    save(); return;
  }
  if(act==='del'){
    tasks = tasks.filter(x=>x.id!==id); save(); return;
  }
});

/* ------------ é€‰é¡¹å¡ ------------- */
$$('.tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    $$('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    currentTab = tab.dataset.tab;
    render();
  });
});

/* ------------ é€šçŸ¥ä¸æé†’ ------------- */
async function requestNotify(){
  if(!('Notification' in window)) return;
  if(Notification.permission==='default'){
    try{ await Notification.requestPermission(); }catch{}
  }
}
async function notifySchedule(){
  // ç®€æ˜“è½®è¯¢ï¼ˆä»…å½“é¡µé¢æ‰“å¼€æ—¶è§¦å‘ï¼Œå·²è¶³å¤Ÿç”¨ï¼›æ›´é«˜çº§å¯ç”¨ service worker + Pushï¼‰
  if(window.__tick) return;
  window.__tick = setInterval(()=>{
    const now = Date.now();
    for(const t of tasks){
      if(t.done || !t.notifyAt) continue;
      const at = new Date(t.notifyAt).getTime();
      if(at && now >= at){
        try{
          if(Notification.permission==='granted'){
            new Notification('æé†’ï¼š'+t.title,{ body: (t.date||'')+' '+(t.time||''), tag:t.id});
          }
        }catch{}
        // å¤„ç†é‡å¤
        if(t.repeat && t.repeat!=='none'){
          const d=new Date(at);
          if(t.repeat==='daily') d.setDate(d.getDate()+1);
          if(t.repeat==='workdays'){ // å‘¨ä¸€åˆ°å‘¨äº”
            do{ d.setDate(d.getDate()+1); }while([0,6].includes(d.getDay()));
          }
          if(t.repeat==='weekly') d.setDate(d.getDate()+7);
          if(t.repeat==='monthly') d.setMonth(d.getMonth()+1);
          t.date = d.toISOString().slice(0,10);
          t.notifyAt = setAtTime(t.date, t.time);
        }else{
          t.notifyAt=null; // å•æ¬¡
        }
      }
    }
    save();
  }, 1000*20); // 20ç§’æ£€æŸ¥ä¸€æ¬¡
}

/* ------------ å¯åŠ¨ ------------- */
requestNotify();
render();
notifySchedule();

// æ³¨å†Œç°æœ‰ service workerï¼ˆå¦‚æœä»“åº“é‡Œæœ‰ï¼‰
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./pwabuilder-sw.js').catch(()=>{});
}
</script>
</body>
</html>

<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>æˆ‘çš„ä¸€å¤©</title>
<meta name="theme-color" content="#0b1220" />
<style>
  :root{--bg:#0b1220;--card:#121a2a;--mut:#7c8aa5;--txt:#eaf1ff;--acc:#4e9bff;--ok:#39d98a;--dang:#ff6b6b;--ring:rgba(78,155,255,.25)}
  .light{--bg:#f6f7fb;--card:#fff;--mut:#667085;--txt:#0b1220;--acc:#316de8;--ok:#12b76a;--dang:#ef4444;--ring:rgba(49,109,232,.2)}
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans SC','PingFang SC',sans-serif}
  .wrap{max-width:820px;margin:0 auto;padding:16px 16px 96px}

  .top{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px 0 12px}
  .title{font-size:24px;font-weight:800}
  .clock{display:flex;flex-direction:column;align-items:flex-end}
  .clock .date{font-size:14px;color:var(--mut)}
  .clock .time{font-size:20px;font-weight:800}
  .iconbtn{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:12px;background:var(--card);box-shadow:0 0 0 1px rgba(255,255,255,.04);color:var(--txt)}

  .card{background:var(--card);border-radius:16px;padding:14px 12px;box-shadow:0 0 0 1px rgba(255,255,255,.04);margin-bottom:14px}
  .label{font-size:13px;color:var(--mut);margin-bottom:6px}
  .input{display:flex;align-items:center;background:#0000;border:1.5px solid rgba(126,141,173,.25);border-radius:14px;padding:12px}
  .input:focus-within{border-color:var(--acc);box-shadow:0 0 0 6px var(--ring)}
  .input input{flex:1;background:transparent;border:0;outline:none;color:var(--txt);font-size:16px}
  .btn{display:inline-flex;align-items:center;justify-content:center;padding:11px 14px;border-radius:12px;background:var(--acc);color:#fff;border:0;font-size:15px}
  .btn.ghost{background:transparent;border:1.5px solid rgba(126,141,173,.28);color:var(--txt)}
  .btn.danger{background:var(--dang)}
  .btn:disabled{opacity:.5}
  .chips{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .chip{display:inline-flex;align-items:center;gap:6px;background:#0000;border:1.5px solid rgba(126,141,173,.25);border-radius:12px;padding:10px 12px;font-size:14px;color:var(--txt)}
  .helper{font-size:12px;color:var(--mut);margin-top:6px}

  .group{margin-top:14px}
  .ghead{display:flex;align-items:center;justify-content:space-between;padding:8px 4px}
  .gtitle{font-weight:800}
  .gcount{color:var(--mut);font-size:12px}
  .list{display:flex;flex-direction:column;gap:10px}

  .task{background:var(--card);border-radius:16px;padding:12px;display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;box-shadow:0 0 0 1px rgba(255,255,255,.04)}
  .name{font-weight:600}
  .meta{display:flex;gap:8px;flex-wrap:wrap}
  .pill{padding:2px 8px;border-radius:999px;background:rgba(126,141,173,.16);font-size:12px;color:var(--mut)}
  .mut{color:var(--mut)}

  .stars{display:inline-flex;align-items:center;gap:6px}
  .star{font-size:18px;opacity:.35;cursor:pointer}
  .star.active{opacity:1;color:#ffd54d}
  .stars .count{font-size:12px;color:var(--mut);margin-left:4px}

  .minirow{margin-top:8px;display:none;gap:8px;align-items:center;flex-wrap:wrap}
  .minirow.show{display:flex}
  .mini{padding:6px 10px;border-radius:10px;font-size:13px;border:1.5px solid rgba(126,141,173,.28);background:#0000;color:var(--txt)}
  .ok{color:var(--ok)}
</style>
</head>
<body>
  <div class="wrap">

    <!-- Header -->
    <div class="top">
      <div class="title">æˆ‘çš„ä¸€å¤©</div>
      <div class="clock">
        <div class="date" id="todayDate">â€”</div>
        <div class="time" id="nowTime">â€”</div>
      </div>
      <button class="iconbtn" id="bellBtn" aria-label="æé†’è®¾ç½®">ğŸ””</button>
      <button class="iconbtn" id="themeBtn" aria-label="æ·±æµ…æ¨¡å¼">ğŸŒ™</button>
    </div>

    <!-- Composer -->
    <div class="card">
      <div class="label">è¾“å…¥ä»»åŠ¡</div>
      <div class="input">
        <input id="taskText" placeholder="ä¾‹å¦‚ï¼šæ˜å¤© 7:30 è·‘æ­¥ï¼ˆæ”¯æŒé‡å¤ä¸ä¼˜å…ˆçº§ï¼‰" autocomplete="off"/>
        <button id="addBtn" class="btn ghost" disabled>æ·»åŠ </button>
      </div>
      <div class="chips">
        <label class="chip">ğŸ“… <input type="date" id="taskDate"></label>
        <label class="chip">â° <input type="time" id="taskTime"></label>
        <label class="chip">ğŸ”
          <select id="repeat">
            <option value="none">ä¸é‡å¤</option>
            <option value="daily">æ¯æ—¥</option>
            <option value="weekly">æ¯å‘¨</option>
            <option value="monthly">æ¯æœˆ</option>
            <option value="yearly">æ¯å¹´</option>
            <option value="custom">è‡ªå®šä¹‰</option>
          </select>
        </label>
        <label class="chip">â­
          <select id="priority">
            <option value="4">4 æ˜Ÿï¼ˆæœ€é‡è¦ï¼‰</option>
            <option value="3">3 æ˜Ÿ</option>
            <option value="2">2 æ˜Ÿ</option>
            <option value="1">1 æ˜Ÿ</option>
            <option value="0">0 æ˜Ÿ</option>
          </select>
        </label>
      </div>
      <div class="helper">æç¤ºï¼šæŒ‰ Enter æˆ–ç‚¹â€œæ·»åŠ â€ã€‚æ—¥æœŸæ—¶é—´å¯éšæ—¶ä¿®æ”¹ï¼›æ˜Ÿçº§ä¼šæŠŠä»»åŠ¡æ”¾åˆ°ç›¸åº”åˆ†ç»„ã€‚</div>
    </div>

    <!-- Groups -->
    <div id="groups"></div>

  </div>

<script>
(() => {
  const $ = s=>document.querySelector(s);
  const groupsEl = $('#groups');
  const addBtn = $('#addBtn');
  const textEl = $('#taskText'), dateEl = $('#taskDate'), timeEl = $('#taskTime'), repeatEl = $('#repeat'), prioEl = $('#priority');

  // clock & theme
  const df = new Intl.DateTimeFormat('zh-CN',{year:'numeric',month:'2-digit',day:'2-digit'});
  const tf = new Intl.DateTimeFormat('zh-CN',{hour:'numeric',minute:'2-digit',hour12:true});
  function tick(){ const n=new Date(); $('#todayDate').textContent=df.format(n); $('#nowTime').textContent=tf.format(n); }
  tick(); setInterval(tick,1000);
  const themeBtn = $('#themeBtn'); function setTheme(m){ if(m==='light'){document.body.classList.add('light');themeBtn.textContent='ğŸŒ';}else{document.body.classList.remove('light');themeBtn.textContent='ğŸŒ™';} localStorage.setItem('theme',m); }
  setTheme(localStorage.getItem('theme')||'dark');
  themeBtn.addEventListener('click',()=>setTheme(document.body.classList.contains('light')?'dark':'light'));

  // notif (Android-first)
  $('#bellBtn').addEventListener('click', async ()=>{
    if(!('Notification' in window)){ alert('å½“å‰ç¯å¢ƒä¸æ”¯æŒé€šçŸ¥'); return; }
    const p = await Notification.requestPermission();
    alert(p==='granted'?'é€šçŸ¥å·²æˆæƒã€‚åˆ°ç‚¹å°†æ˜¾ç¤ºæé†’ã€‚':'æœªæˆæƒé€šçŸ¥ã€‚');
  });

  // storage
  const KEY='todo.v5';
  let tasks=JSON.parse(localStorage.getItem(KEY)||'[]');
  function save(){ localStorage.setItem(KEY, JSON.stringify(tasks)); }
  const uid=()=>Math.random().toString(36).slice(2,9);
  const rLabel=v=>({none:'ä¸é‡å¤',daily:'æ¯æ—¥',weekly:'æ¯å‘¨',monthly:'æ¯æœˆ',yearly:'æ¯å¹´',custom:'è‡ªå®šä¹‰'}[v]||'ä¸é‡å¤');
  const fmt = iso => { if(!iso) return 'æ— æ—¶é—´'; const d=new Date(iso); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${tf.format(d)}`; };
  const parseWhen=(ds,ts)=>{ if(!ds && !ts) return null; const d=new Date(); if(ds){const[a,b,c]=ds.split('-').map(Number); d.setFullYear(a,b-1,c);} if(ts){const[h,m]=ts.split(':').map(Number); d.setHours(h,m||0,0,0);} return d.toISOString(); };

  // composer
  function primeDefaults(){
    const now=new Date();
    dateEl.value = now.toISOString().slice(0,10);
    now.setMinutes(now.getMinutes()+30-now.getMinutes()%30,0,0);
    timeEl.value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  }
  primeDefaults();
  textEl.addEventListener('input',()=>addBtn.disabled=!textEl.value.trim());
  textEl.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); addTask(); }});
  addBtn.addEventListener('click', addTask);
  function addTask(){
    const title=textEl.value.trim(); if(!title) return;
    const t={ id:uid(), title, when:parseWhen(dateEl.value,timeEl.value), repeat:repeatEl.value, priority:Number(prioEl.value), done:false };
    tasks.push(t); save(); schedule(t); render(); textEl.value=''; addBtn.disabled=true;
  }

  // render groups by priority
  function render(){
    groupsEl.innerHTML='';
    const prios=[4,3,2,1,0];
    prios.forEach(p=>{
      const section=document.createElement('div'); section.className='group';
      const list=document.createElement('div'); list.className='list'; list.id=`list-${p}`;
      const count = tasks.filter(t=>t.priority===p).length;
      section.innerHTML=`<div class="ghead">
         <div class="gtitle">â­${p} ${p===4?'ï¼ˆæœ€é‡è¦ï¼‰':''}</div>
         <div class="gcount">${count}</div>
       </div>`;
      section.appendChild(list);
      groupsEl.appendChild(section);
    });
    // sort inside each group: undone first, by time asc
    tasks.sort((a,b)=>Number(a.done)-Number(b.done) || (a.when||'').localeCompare(b.when||''));
    tasks.forEach(t=>{
      document.querySelector(`#list-${t.priority}`)?.appendChild(renderTask(t));
    });
    // show empty placeholders
    document.querySelectorAll('.list').forEach(ul=>{
      if(!ul.children.length){
        const empty=document.createElement('div');
        empty.className='mut'; empty.style.padding='8px 4px'; empty.textContent='ï¼ˆæš‚æ— ä»»åŠ¡ï¼‰';
        ul.appendChild(empty);
      }
    });
  }

  function renderTask(t){
    const row=document.createElement('div');
    row.className='task';
    row.innerHTML=`
      <input type="checkbox" ${t.done?'checked':''} aria-label="å®Œæˆ"/>
      <div>
        <div class="name">${escapeHtml(t.title)}</div>
        <div class="meta">
          <span class="mut">ğŸ“… ${fmt(t.when)}</span>
          ${t.repeat!=='none'?`<span class="pill">ğŸ” ${rLabel(t.repeat)}</span>`:''}
        </div>
        <div class="meta" style="margin-top:8px">
          <button class="mini" data-edit="date">ğŸ“… ä¿®æ”¹æ—¥æœŸ</button>
          <button class="mini" data-edit="time">â° ä¿®æ”¹æ—¶é—´</button>
          <div class="stars" data-id="${t.id}">
            <span class="star" data-v="1">â˜…</span>
            <span class="star" data-v="2">â˜…</span>
            <span class="star" data-v="3">â˜…</span>
            <span class="star" data-v="4">â˜…</span>
            <span class="count">(${t.priority})</span>
          </div>
        </div>
        <div class="minirow" id="edit-${t.id}">
          <input class="mini" type="date" id="date-${t.id}">
          <input class="mini" type="time" id="time-${t.id}">
          <button class="mini btn ghost ok" data-save="${t.id}">ä¿å­˜</button>
          <button class="mini btn ghost" data-cancel="${t.id}">å–æ¶ˆ</button>
        </div>
      </div>
      <div>
        <button class="btn danger" data-del="${t.id}">åˆ é™¤</button>
      </div>
    `;
    // complete
    row.querySelector('input[type=checkbox]').addEventListener('change',e=>{
      t.done=e.target.checked; save(); render();
    });
    // edit toggles
    row.querySelector('[data-edit="date"]').addEventListener('click',()=>openEditor(t.id,'date'));
    row.querySelector('[data-edit="time"]').addEventListener('click',()=>openEditor(t.id,'time'));
    // fill editor values
    const ed=row.querySelector(`#edit-${t.id}`);
    const dI=row.querySelector(`#date-${t.id}`), hI=row.querySelector(`#time-${t.id}`);
    if(t.when){ const d=new Date(t.when); dI.value=d.toISOString().slice(0,10); hI.value=`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }
    // save / cancel
    row.querySelector(`[data-save="${t.id}"]`).addEventListener('click',()=>{
      const when=parseWhen(dI.value,hI.value);
      t.when=when; save(); schedule(t); render();
    });
    row.querySelector(`[data-cancel="${t.id}"]`).addEventListener('click',()=>{ ed.classList.remove('show'); });

    // delete
    row.querySelector(`[data-del="${t.id}"]`).addEventListener('click',()=>{
      tasks=tasks.filter(x=>x.id!==t.id); save(); render();
    });

    // stars
    const stars=row.querySelectorAll('.star');
    const paint=()=>{ stars.forEach(s=>s.classList.toggle('active', Number(s.dataset.v)<=t.priority)); row.querySelector('.count').textContent=`(${t.priority})`; };
    paint();
    stars.forEach(s=>s.addEventListener('click',()=>{
      const newPri=Number(s.dataset.v);
      if(t.priority!==newPri){ t.priority=newPri; save(); render(); } // move to correct section
    }));

    function openEditor(id,which){
      ed.classList.add('show');
      if(which==='date') dI.focus(); else hI.focus();
    }
    return row;
  }

  function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}

  // scheduling + notify
  function schedule(t){
    if(t._timer){ clearTimeout(t._timer); t._timer=null; }
    if(!t.when || t.done) return;
    const ms=new Date(t.when).getTime()-Date.now();
    if(ms<=0) return;
    t._timer=setTimeout(()=>{
      if('Notification'in window && Notification.permission==='granted'){
        new Notification('åˆ°ç‚¹å•¦',{body:t.title});
      }else{ alert(`åˆ°ç‚¹å•¦ï¼š${t.title}`); }
      if(t.repeat && t.repeat!=='none'){
        const d=new Date(t.when);
        switch(t.repeat){
          case 'daily': d.setDate(d.getDate()+1); break;
          case 'weekly': d.setDate(d.getDate()+7); break;
          case 'monthly': d.setMonth(d.getMonth()+1); break;
          case 'yearly': d.setFullYear(d.getFullYear()+1); break;
          case 'custom': d.setDate(d.getDate()+3); break;
        }
        t.when=d.toISOString(); save(); render(); schedule(t);
      }
    }, ms);
  }

  // init
  tasks.forEach(schedule);
  render();
})();
</script>
</body>
</html>
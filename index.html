<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>æˆ‘çš„ä¸€å¤©</title>
<meta name="theme-color" content="#0b1220" />
<style>
  :root{
    --bg:#0b1220;--card:#121a2a;--muted:#7c8aa5;--txt:#eaf1ff;--accent:#4e9bff;--ok:#39d98a;--danger:#ff6b6b;--ring:rgba(78,155,255,.25);
  }
  .light{
    --bg:#f6f7fb;--card:#ffffff;--muted:#667085;--txt:#0b1220;--accent:#316de8;--ok:#12b76a;--danger:#ef4444;--ring:rgba(49,109,232,.2);
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans SC','PingFang SC',sans-serif}
  .wrap{max-width:780px;margin:0 auto;padding:16px 16px 80px}
  /* header */
  .top{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px 0 12px}
  .title{font-size:24px;font-weight:800;letter-spacing:.5px}
  .clock{display:flex;flex-direction:column;align-items:flex-end}
  .clock .date{font-size:14px;color:var(--muted)}
  .clock .time{font-size:20px;font-weight:800}
  .iconbtn{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:12px;background:var(--card);box-shadow:0 0 0 1px rgba(255,255,255,.04);color:var(--txt)}
  .row{display:flex;align-items:center;gap:10px}
  /* card */
  .card{background:var(--card);border-radius:16px;padding:14px 12px;box-shadow:0 0 0 1px rgba(255,255,255,.04)}
  .label{font-size:13px;color:var(--muted);margin-bottom:6px}
  .input{display:flex;align-items:center;background:#0000;border:1.5px solid rgba(126,141,173,.25);border-radius:14px;padding:12px}
  .input:focus-within{border-color:var(--accent);box-shadow:0 0 0 6px var(--ring)}
  .input input{flex:1;background:transparent;border:0;outline:none;color:var(--txt);font-size:16px}
  .chip{display:inline-flex;align-items:center;gap:6px;background:#0000;border:1.5px solid rgba(126,141,173,.25);border-radius:12px;padding:10px 12px;font-size:14px;color:var(--txt)}
  .chip:focus-visible{outline:none;border-color:var(--accent);box-shadow:0 0 0 6px var(--ring)}
  .chip .icon{opacity:.75}
  .chips{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .right{margin-left:auto}
  .btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 14px;border-radius:12px;background:var(--accent);color:#fff;border:0;font-size:15px}
  .btn:disabled{opacity:.5}
  .subtle{background:transparent;border:1.5px solid rgba(126,141,173,.25);color:var(--txt)}
  /* quick snooze */
  .snooze{display:flex;gap:8px;margin-top:10px}
  .snooze button{flex:1;padding:10px 0;border-radius:12px;border:1.5px solid rgba(126,141,173,.25);background:#0000;color:var(--txt)}
  .snooze button:active{transform:scale(.98)}
  /* list */
  .list{margin-top:16px;display:flex;flex-direction:column;gap:10px}
  .task{background:var(--card);border-radius:16px;padding:12px;display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;box-shadow:0 0 0 1px rgba(255,255,255,.04)}
  .task .name{font-weight:600}
  .meta{display:flex;gap:8px;flex-wrap:wrap}
  .count{margin-left:6px;padding:2px 8px;border-radius:999px;font-size:12px;background:rgba(126,141,173,.16);color:var(--muted)}
  .ok{color:var(--ok)}
  .danger{color:var(--danger)}
  .muted{color:var(--muted)}
  /* bell panel */
  .sheet{position:fixed;inset:auto 0 0 0;translate:0 100%;transition:translate .25s ease;background:var(--card);border-radius:16px 16px 0 0;box-shadow:0 -12px 30px rgba(0,0,0,.35);padding:16px 16px 24px;max-width:780px;margin:0 auto}
  .sheet.open{translate:0 0}
  .sheet h3{margin:0 0 12px 0}
  .sheet .row{justify-content:space-between}
  .switch{position:relative;width:46px;height:28px;border-radius:999px;background:rgba(126,141,173,.3)}
  .switch input{opacity:0;width:0;height:0}
  .knob{position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:50%;background:#fff;transition:left .2s}
  .switch input:checked + .knob{left:21px;background:var(--accent)}
  .helper{font-size:12px;color:var(--muted);margin-top:6px}
  .empty{padding:18px;text-align:center;color:var(--muted);border:1.5px dashed rgba(126,141,173,.35);border-radius:14px}
  .hide{display:none}
</style>
</head>
<body>
  <div class="wrap">

    <!-- HEADER -->
    <div class="top">
      <div class="title">æˆ‘çš„ä¸€å¤©</div>
      <div class="clock">
        <div class="date" id="todayDate">â€”</div>
        <div class="time" id="nowTime">â€”</div>
      </div>
      <button class="iconbtn" id="bellBtn" aria-label="æé†’è®¾ç½®">ğŸ””</button>
      <button class="iconbtn" id="themeBtn" aria-label="æ·±æµ…æ¨¡å¼">ğŸŒ™</button>
    </div>

    <!-- INPUT CARD -->
    <div class="card" id="composer">
      <div class="label">è¾“å…¥ä»»åŠ¡</div>
      <div class="input">
        <input id="taskText" placeholder="ä¾‹å¦‚ï¼šæ˜å¤© 7:30 è·‘æ­¥ï¼Œæ¯å¤©æé†’" autocomplete="off" />
        <button id="enterBtn" class="btn subtle right" disabled>æ·»åŠ </button>
      </div>

      <div class="chips" style="margin-top:12px">
        <label class="chip">
          <span class="icon">ğŸ“…</span>
          <input type="date" id="taskDate" />
        </label>
        <label class="chip">
          <span class="icon">â°</span>
          <input type="time" id="taskTime" />
        </label>

        <label class="chip">
          <span class="icon">ğŸ”</span>
          <select id="repeat">
            <option value="none">ä¸é‡å¤</option>
            <option value="daily">æ¯æ—¥</option>
            <option value="weekly">æ¯å‘¨</option>
            <option value="monthly">æ¯æœˆ</option>
            <option value="yearly">æ¯å¹´</option>
            <option value="custom">è‡ªå®šä¹‰</option>
          </select>
        </label>

        <label class="chip">
          <span class="icon">â­</span>
          <input id="important" type="checkbox" /> é‡è¦
        </label>
      </div>

      <!-- å¿«é€Ÿç¨å -->
      <div class="snooze">
        <button data-min="5">ç¨å 5 åˆ†é’Ÿ</button>
        <button data-min="10">ç¨å 10 åˆ†é’Ÿ</button>
        <button data-min="30">ç¨å 30 åˆ†é’Ÿ</button>
      </div>

      <div class="helper">æç¤ºï¼šè¾“å…¥åå¯æŒ‰ <b>Enter</b> ç›´æ¥æ·»åŠ ï¼›æ—¥æœŸä¸æ—¶é—´éšæ—¶å¯ä¿®æ”¹ã€‚</div>
    </div>

    <!-- LIST -->
    <div class="list" id="list"></div>
    <div id="emptyState" class="empty">æ²¡æœ‰ä»»åŠ¡ï¼Œå¼€å§‹æ·»åŠ ä½ çš„ç¬¬ä¸€ä¸ªä»»åŠ¡å§ã€‚</div>

    <!-- REMINDER SHEET -->
    <div id="sheet" class="sheet" aria-hidden="true">
      <h3>æé†’è®¾ç½®</h3>
      <div class="row">
        <div>
          <div>å…è®¸é€šçŸ¥</div>
          <div class="helper">å¯ç”¨ååˆ°ç‚¹å°†æ¨é€æé†’ï¼ˆæµè§ˆå™¨/ç³»ç»Ÿæ”¯æŒæ—¶ï¼‰ã€‚</div>
        </div>
        <label class="switch">
          <input id="notifToggle" type="checkbox">
          <span class="knob"></span>
        </label>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="testNotif" class="btn subtle">æµ‹è¯•æé†’</button>
        <button id="closeSheet" class="btn">å®Œæˆ</button>
      </div>
      <div class="helper">iOS Safari éœ€è¦æ·»åŠ åˆ°ä¸»å±å¹•(PWA)å¹¶å…è®¸é€šçŸ¥åæ‰ä¼šæ¨é€ï¼›å¦åˆ™ä¼šä½¿ç”¨å¯¹è¯æ¡†æé†’ã€‚</div>
    </div>

  </div>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const listEl = $('#list');
  const emptyEl = $('#emptyState');
  const enterBtn = $('#enterBtn');
  const textEl = $('#taskText');
  const dateEl = $('#taskDate');
  const timeEl = $('#taskTime');
  const repeatEl = $('#repeat');
  const impEl = $('#important');
  const snoozeBtns = document.querySelectorAll('.snooze button');

  // ====== time header ======
  const dateFmt = new Intl.DateTimeFormat('zh-CN',{year:'numeric',month:'2-digit',day:'2-digit'});
  const timeFmt = new Intl.DateTimeFormat('zh-CN',{hour:'numeric',minute:'2-digit',hour12:true});
  function tick(){
    const now = new Date();
    $('#todayDate').textContent = dateFmt.format(now);
    $('#nowTime').textContent = timeFmt.format(now);
  }
  tick(); setInterval(tick,1000);

  // ====== theme toggle ======
  const themeBtn = $('#themeBtn');
  function setTheme(mode){
    if(mode==='light'){ document.body.classList.add('light'); themeBtn.textContent='ğŸŒ'; }
    else { document.body.classList.remove('light'); themeBtn.textContent='ğŸŒ™'; }
    localStorage.setItem('theme',mode);
  }
  setTheme(localStorage.getItem('theme')||'dark');
  themeBtn.addEventListener('click',()=>setTheme(document.body.classList.contains('light')?'dark':'light'));

  // ====== notifications sheet ======
  const sheet = $('#sheet'), bell = $('#bellBtn'), notifToggle = $('#notifToggle');
  const closeSheet = $('#closeSheet'), testNotif = $('#testNotif');
  function openSheet(){ sheet.classList.add('open'); sheet.setAttribute('aria-hidden','false'); }
  function closeSheetFn(){ sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true'); }
  bell.addEventListener('click', openSheet);
  closeSheet.addEventListener('click', closeSheetFn);
  // load notif pref
  notifToggle.checked = localStorage.getItem('notifEnabled')==='1';
  notifToggle.addEventListener('change', async () => {
    if(notifToggle.checked){
      if('Notification' in window){
        try{
          const perm = await Notification.requestPermission();
          if(perm!=='granted'){ notifToggle.checked=false; alert('æœªæˆäºˆé€šçŸ¥æƒé™'); return; }
        }catch(e){ /* ignore */ }
      }
      localStorage.setItem('notifEnabled','1');
    }else{
      localStorage.removeItem('notifEnabled');
    }
  });
  testNotif.addEventListener('click', () => notify('æµ‹è¯•æé†’','è¿™æ˜¯ä¸€ä¸ªæé†’ç¤ºä¾‹ã€‚'));

  // ====== storage ======
  const storeKey = 'todo.v3';
  let tasks = JSON.parse(localStorage.getItem(storeKey)||'[]');

  function save(){ localStorage.setItem(storeKey, JSON.stringify(tasks)); }
  function uid(){ return Math.random().toString(36).slice(2,9); }

  // ====== render ======
  function render(){
    listEl.innerHTML='';
    if(!tasks.length){ emptyEl.classList.remove('hide'); return; }
    emptyEl.classList.add('hide');
    tasks.sort((a,b)=>Number(a.done)-Number(b.done) || (a.when||'').localeCompare(b.when||''));
    for(const t of tasks){
      const row = document.createElement('div');
      row.className = 'task';
      row.innerHTML = `
        <input type="checkbox" ${t.done?'checked':''} aria-label="å®Œæˆ" />
        <div>
          <div class="name">${escapeHtml(t.title)}</div>
          <div class="meta">
            ${t.when?`<span class="muted">ğŸ“… ${fmtReadable(t.when)}</span>`:''}
            ${t.repeat!=='none'?`<span class="muted">ğŸ” ${repeatLabel(t.repeat)}</span>`:''}
            ${t.important?`<span class="muted">â­ é‡è¦</span>`:''}
          </div>
        </div>
        <div class="row">
          <button class="btn subtle" data-act="s5">+5åˆ†</button>
          <button class="btn subtle" data-act="s10">+10åˆ†</button>
          <button class="btn subtle" data-act="s30">+30åˆ†</button>
          <button class="btn danger" data-act="del">åˆ é™¤</button>
        </div>
      `;
      // events
      const [ck] = row.getElementsByTagName('input');
      ck.addEventListener('change',()=>{ t.done = ck.checked; save(); render(); });

      row.querySelector('[data-act="del"]').addEventListener('click',()=>{
        tasks = tasks.filter(x=>x.id!==t.id); save(); render();
      });
      row.querySelector('[data-act="s5"]').addEventListener('click',()=>snoozeTask(t,5));
      row.querySelector('[data-act="s10"]').addEventListener('click',()=>snoozeTask(t,10));
      row.querySelector('[data-act="s30"]').addEventListener('click',()=>snoozeTask(t,30));

      listEl.appendChild(row);
    }
  }

  function escapeHtml(s){ return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function repeatLabel(v){
    return {none:'ä¸é‡å¤',daily:'æ¯æ—¥',weekly:'æ¯å‘¨',monthly:'æ¯æœˆ',yearly:'æ¯å¹´',custom:'è‡ªå®šä¹‰'}[v]||'ä¸é‡å¤';
  }
  function fmtReadable(iso){
    const d=new Date(iso);
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${timeFmt.format(d)}`;
  }

  // ====== add task ======
  function parseWhen(dateStr,timeStr){
    if(!dateStr && !timeStr) return null;
    const d = new Date();
    if(dateStr){ const [y,m,dd] = dateStr.split('-').map(Number); d.setFullYear(y,m-1,dd); }
    if(timeStr){ const [hh,mm] = timeStr.split(':').map(Number); d.setHours(hh,mm||0,0,0); }
    return d.toISOString();
  }

  function addTask(){
    const title = textEl.value.trim();
    if(!title) return;
    const when = parseWhen(dateEl.value, timeEl.value);
    const t = { id:uid(), title, when, repeat:repeatEl.value, important:impEl.checked, done:false };
    tasks.push(t); save(); schedule(t); render();
    // clear text only
    textEl.value=''; enterBtn.disabled=true;
  }

  textEl.addEventListener('input',()=>{ enterBtn.disabled = !textEl.value.trim(); });
  textEl.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); addTask(); }});
  enterBtn.addEventListener('click', addTask);

  // quick snooze for composer
  snoozeBtns.forEach(btn=>{
    btn.addEventListener('click',()=>{
      const min = Number(btn.dataset.min)||5;
      const base = dateEl.value && timeEl.value ? new Date(parseWhen(dateEl.value, timeEl.value)) : new Date();
      base.setMinutes(base.getMinutes()+min);
      dateEl.value = base.toISOString().slice(0,10);
      timeEl.value = `${String(base.getHours()).padStart(2,'0')}:${String(base.getMinutes()).padStart(2,'0')}`;
    });
  });

  // ====== notifications & scheduling ======
  function notify(title, body){
    const enabled = localStorage.getItem('notifEnabled')==='1';
    if(enabled && 'Notification' in window && Notification.permission==='granted'){
      new Notification(title, { body });
    }else{
      alert(`${title}\n\n${body}`);
    }
  }

  function schedule(t){
    // clear previous timer if any
    if(t._timer){ clearTimeout(t._timer); t._timer=null; }
    if(!t.when || t.done) return;
    const ts = new Date(t.when).getTime() - Date.now();
    if(ts <= 0) return;
    t._timer = setTimeout(()=>{
      notify('åˆ°ç‚¹å•¦', t.title);
      // handle repeat
      if(t.repeat && t.repeat!=='none'){
        const d = new Date(t.when);
        switch(t.repeat){
          case 'daily': d.setDate(d.getDate()+1); break;
          case 'weekly': d.setDate(d.getDate()+7); break;
          case 'monthly': d.setMonth(d.getMonth()+1); break;
          case 'yearly': d.setFullYear(d.getFullYear()+1); break;
          case 'custom': d.setDate(d.getDate()+3); break; // ç®€å•ç¤ºä¾‹ï¼šè‡ªå®šä¹‰=+3å¤©
        }
        t.when = d.toISOString(); save(); render(); schedule(t);
      }
    }, ts);
  }

  function snoozeTask(t, min){
    const d = t.when ? new Date(t.when) : new Date();
    d.setMinutes(d.getMinutes()+min);
    t.when = d.toISOString(); save(); render(); schedule(t);
  }

  // ===== init =====
  // default pickers -> today + next half hour
  (function initPickers(){
    const now = new Date();
    dateEl.value = now.toISOString().slice(0,10);
    now.setMinutes(now.getMinutes()+30-now.getMinutes()%30,0,0);
    timeEl.value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  })();

  tasks.forEach(schedule);
  render();

})();
</script>
</body>
</html>
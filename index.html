<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>æˆ‘çš„ä¸€å¤©</title>
<meta name="theme-color" content="#0b1220" />
<style>
  :root{--bg:#0b1220;--card:#121a2a;--muted:#7c8aa5;--txt:#eaf1ff;--accent:#4e9bff;--ok:#39d98a;--danger:#ff6b6b;--ring:rgba(78,155,255,.25);}
  .light{--bg:#f6f7fb;--card:#ffffff;--muted:#667085;--txt:#0b1220;--accent:#316de8;--ok:#12b76a;--danger:#ef4444;--ring:rgba(49,109,232,.2);}
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans SC','PingFang SC',sans-serif}
  .wrap{max-width:780px;margin:0 auto;padding:16px 16px 80px}

  /* header */
  .top{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px 0 12px}
  .title{font-size:24px;font-weight:800;letter-spacing:.5px}
  .clock{display:flex;flex-direction:column;align-items:flex-end}
  .clock .date{font-size:14px;color:var(--muted)}
  .clock .time{font-size:20px;font-weight:800}
  .iconbtn{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:12px;background:var(--card);box-shadow:0 0 0 1px rgba(255,255,255,.04);color:var(--txt)}

  /* card & inputs */
  .card{background:var(--card);border-radius:16px;padding:14px 12px;box-shadow:0 0 0 1px rgba(255,255,255,.04)}
  .label{font-size:13px;color:var(--muted);margin-bottom:6px}
  .input{display:flex;align-items:center;background:#0000;border:1.5px solid rgba(126,141,173,.25);border-radius:14px;padding:12px}
  .input:focus-within{border-color:var(--accent);box-shadow:0 0 0 6px var(--ring)}
  .input input{flex:1;background:transparent;border:0;outline:none;color:var(--txt);font-size:16px}
  .btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 14px;border-radius:12px;background:var(--accent);color:#fff;border:0;font-size:15px}
  .btn:disabled{opacity:.5}
  .subtle{background:transparent;border:1.5px solid rgba(126,141,173,.25);color:var(--txt)}
  .chips{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .chip{display:inline-flex;align-items:center;gap:6px;background:#0000;border:1.5px solid rgba(126,141,173,.25);border-radius:12px;padding:10px 12px;font-size:14px;color:var(--txt)}
  .chip:focus-visible{outline:none;border-color:var(--accent);box-shadow:0 0 0 6px var(--ring)}
  .chip .icon{opacity:.75}

  .helper{font-size:12px;color:var(--muted);margin-top:6px}

  /* list */
  .list{margin-top:16px;display:flex;flex-direction:column;gap:10px}
  .task{background:var(--card);border-radius:16px;padding:12px;display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;box-shadow:0 0 0 1px rgba(255,255,255,.04)}
  .task .name{font-weight:600}
  .meta{display:flex;gap:8px;flex-wrap:wrap}
  .muted{color:var(--muted)}
  .danger{color:var(--danger)}
  .ok{color:var(--ok)}
  .pill{padding:2px 8px;border-radius:999px;background:rgba(126,141,173,.16);font-size:12px;color:var(--muted)}

  /* stars */
  .stars{display:inline-flex;align-items:center;gap:6px}
  .star{font-size:18px;opacity:.35;cursor:pointer}
  .star.active{opacity:1;color:#ffd54d}
  .stars .count{font-size:12px;color:var(--muted);margin-left:4px}

  /* edit chips inside task */
  .mini{padding:6px 10px;border-radius:10px;font-size:13px}
  .hidden{position:absolute;opacity:0;pointer-events:none;height:0;width:0}

  /* bell sheet */
  .sheet{position:fixed;inset:auto 0 0 0;translate:0 100%;transition:translate .25s ease;background:var(--card);border-radius:16px 16px 0 0;box-shadow:0 -12px 30px rgba(0,0,0,.35);padding:16px 16px 24px;max-width:780px;margin:0 auto}
  .sheet.open{translate:0 0}
  .sheet h3{margin:0 0 12px 0}
  .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .switch{position:relative;width:46px;height:28px;border-radius:999px;background:rgba(126,141,173,.3)}
  .switch input{opacity:0;width:0;height:0}
  .knob{position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:50%;background:#fff;transition:left .2s}
  .switch input:checked + .knob{left:21px;background:var(--accent)}
  .empty{padding:18px;text-align:center;color:var(--muted);border:1.5px dashed rgba(126,141,173,.35);border-radius:14px}
  .hide{display:none}
</style>
</head>
<body>
  <div class="wrap">

    <!-- HEADER -->
    <div class="top">
      <div class="title">æˆ‘çš„ä¸€å¤©</div>
      <div class="clock">
        <div class="date" id="todayDate">â€”</div>
        <div class="time" id="nowTime">â€”</div>
      </div>
      <button class="iconbtn" id="bellBtn" aria-label="æé†’è®¾ç½®">ğŸ””</button>
      <button class="iconbtn" id="themeBtn" aria-label="æ·±æµ…æ¨¡å¼">ğŸŒ™</button>
    </div>

    <!-- COMPOSER -->
    <div class="card">
      <div class="label">è¾“å…¥ä»»åŠ¡</div>
      <div class="input">
        <input id="taskText" placeholder="ä¾‹å¦‚ï¼šæ˜å¤© 7:30 è·‘æ­¥ï¼ˆæ”¯æŒé‡å¤ä¸ä¼˜å…ˆçº§ï¼‰" autocomplete="off" />
        <button id="enterBtn" class="btn subtle" disabled>æ·»åŠ </button>
      </div>

      <div class="chips">
        <label class="chip">
          <span class="icon">ğŸ“…</span>
          <input type="date" id="taskDate" />
        </label>
        <label class="chip">
          <span class="icon">â°</span>
          <input type="time" id="taskTime" />
        </label>
        <label class="chip">
          <span class="icon">ğŸ”</span>
          <select id="repeat">
            <option value="none">ä¸é‡å¤</option>
            <option value="daily">æ¯æ—¥</option>
            <option value="weekly">æ¯å‘¨</option>
            <option value="monthly">æ¯æœˆ</option>
            <option value="yearly">æ¯å¹´</option>
            <option value="custom">è‡ªå®šä¹‰</option>
          </select>
        </label>
        <label class="chip">
          <span class="icon">â­</span>
          <select id="priority">
            <option value="0">0 æ˜Ÿ</option>
            <option value="1">1 æ˜Ÿ</option>
            <option value="2">2 æ˜Ÿ</option>
            <option value="3">3 æ˜Ÿ</option>
            <option value="4">4 æ˜Ÿï¼ˆæœ€é‡è¦ï¼‰</option>
          </select>
        </label>
      </div>

      <div class="helper">æç¤ºï¼šè¾“å…¥åæŒ‰ <b>Enter</b> æˆ–ç‚¹â€œæ·»åŠ â€ã€‚æ—¥æœŸä¸æ—¶é—´éšæ—¶å¯ä¿®æ”¹ã€‚</div>
    </div>

    <!-- LIST -->
    <div class="list" id="list"></div>
    <div id="emptyState" class="empty">æ²¡æœ‰ä»»åŠ¡ï¼Œå¼€å§‹æ·»åŠ ä½ çš„ç¬¬ä¸€ä¸ªä»»åŠ¡å§ã€‚</div>

    <!-- REMINDER SHEET -->
    <div id="sheet" class="sheet" aria-hidden="true">
      <h3>æé†’è®¾ç½®</h3>
      <div class="row">
        <div>
          <div>å…è®¸é€šçŸ¥ï¼ˆAndroidï¼‰</div>
          <div class="helper">å¯ç”¨ååˆ°ç‚¹å°†æ¨é€æé†’ï¼›è‹¥ç³»ç»Ÿæˆ–æµè§ˆå™¨ä¸æ”¯æŒï¼Œå°†ä½¿ç”¨å®‰å…¨æç¤ºæ¡†ã€‚</div>
        </div>
        <label class="switch">
          <input id="notifToggle" type="checkbox">
          <span class="knob"></span>
        </label>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="testNotif" class="btn subtle">æµ‹è¯•æé†’</button>
        <button id="closeSheet" class="btn">å®Œæˆ</button>
      </div>
    </div>

  </div>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const listEl = $('#list');
  const emptyEl = $('#emptyState');
  const enterBtn = $('#enterBtn');
  const textEl = $('#taskText');
  const dateEl = $('#taskDate');
  const timeEl = $('#taskTime');
  const repeatEl = $('#repeat');
  const prioEl = $('#priority');

  // ===== header clock =====
  const dateFmt = new Intl.DateTimeFormat('zh-CN',{year:'numeric',month:'2-digit',day:'2-digit'});
  const timeFmt = new Intl.DateTimeFormat('zh-CN',{hour:'numeric',minute:'2-digit',hour12:true});
  function tick(){
    const now = new Date();
    $('#todayDate').textContent = dateFmt.format(now);
    $('#nowTime').textContent = timeFmt.format(now);
  }
  tick(); setInterval(tick,1000);

  // ===== theme toggle =====
  const themeBtn = $('#themeBtn');
  function setTheme(mode){
    if(mode==='light'){ document.body.classList.add('light'); themeBtn.textContent='ğŸŒ'; }
    else { document.body.classList.remove('light'); themeBtn.textContent='ğŸŒ™'; }
    localStorage.setItem('theme',mode);
  }
  setTheme(localStorage.getItem('theme')||'dark');
  themeBtn.addEventListener('click',()=>setTheme(document.body.classList.contains('light')?'dark':'light'));

  // ===== notifications sheet (Android-first wording) =====
  const sheet = $('#sheet'), bell = $('#bellBtn'), notifToggle = $('#notifToggle');
  const closeSheet = $('#closeSheet'), testNotif = $('#testNotif');
  function openSheet(){ sheet.classList.add('open'); sheet.setAttribute('aria-hidden','false'); }
  function closeSheetFn(){ sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true'); }
  bell.addEventListener('click', openSheet);
  closeSheet.addEventListener('click', closeSheetFn);
  notifToggle.checked = localStorage.getItem('notifEnabled')==='1';
  notifToggle.addEventListener('change', async () => {
    if(notifToggle.checked && 'Notification' in window){
      try{
        const perm = await Notification.requestPermission();
        if(perm!=='granted'){ notifToggle.checked=false; alert('æœªæˆäºˆé€šçŸ¥æƒé™'); return; }
      }catch(e){}
      localStorage.setItem('notifEnabled','1');
    }else{
      localStorage.removeItem('notifEnabled');
    }
  });
  testNotif.addEventListener('click', () => notify('æµ‹è¯•æé†’','è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹æé†’ã€‚'));

  function notify(title, body){
    const enabled = localStorage.getItem('notifEnabled')==='1';
    if(enabled && 'Notification' in window && Notification.permission==='granted'){
      new Notification(title, { body });
    }else{
      alert(`${title}\n\n${body}`);
    }
  }

  // ===== storage =====
  const storeKey = 'todo.v4';
  let tasks = JSON.parse(localStorage.getItem(storeKey)||'[]');
  function save(){ localStorage.setItem(storeKey, JSON.stringify(tasks)); }
  function uid(){ return Math.random().toString(36).slice(2,9); }

  // ===== helpers =====
  function escapeHtml(s){ return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function fmtReadable(iso){ const d=new Date(iso); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${timeFmt.format(d)}`; }
  function parseWhen(dateStr,timeStr){
    if(!dateStr && !timeStr) return null;
    const d = new Date();
    if(dateStr){ const [y,m,dd] = dateStr.split('-').map(Number); d.setFullYear(y,m-1,dd); }
    if(timeStr){ const [hh,mm] = timeStr.split(':').map(Number); d.setHours(hh,mm||0,0,0); }
    return d.toISOString();
  }
  function repeatLabel(v){ return {none:'ä¸é‡å¤',daily:'æ¯æ—¥',weekly:'æ¯å‘¨',monthly:'æ¯æœˆ',yearly:'æ¯å¹´',custom:'è‡ªå®šä¹‰'}[v]||'ä¸é‡å¤'; }

  // ===== add task =====
  function addTask(){
    const title = textEl.value.trim();
    if(!title) return;
    const when = parseWhen(dateEl.value, timeEl.value);
    const t = { id:uid(), title, when, repeat:repeatEl.value, priority:Number(prioEl.value||0), done:false };
    tasks.push(t); save(); schedule(t); render();
    textEl.value=''; enterBtn.disabled=true;
  }
  textEl.addEventListener('input',()=>{ enterBtn.disabled = !textEl.value.trim(); });
  textEl.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); addTask(); }});
  enterBtn.addEventListener('click', addTask);

  // ===== render =====
  function render(){
    listEl.innerHTML='';
    if(!tasks.length){ emptyEl.classList.remove('hide'); return; }
    emptyEl.classList.add('hide');
    // sort: by done, priority desc, then time
    tasks.sort((a,b)=>Number(a.done)-Number(b.done) || (b.priority||0)-(a.priority||0) || (a.when||'').localeCompare(b.when||''));
    for(const t of tasks){
      listEl.appendChild(renderTask(t));
    }
  }

  function renderTask(t){
    const row = document.createElement('div');
    row.className='task';
    const whenTxt = t.when ? fmtReadable(t.when) : 'æ— æ—¶é—´';

    row.innerHTML = `
      <input type="checkbox" ${t.done?'checked':''} aria-label="å®Œæˆ" />
      <div>
        <div class="name">${escapeHtml(t.title)}</div>
        <div class="meta">
          <span class="muted">ğŸ“… ${whenTxt}</span>
          ${t.repeat!=='none'?`<span class="pill">ğŸ” ${repeatLabel(t.repeat)}</span>`:''}
        </div>
        <div class="meta" style="margin-top:8px">
          <!-- editable date/time chips -->
          <button class="chip mini" data-edit="date">ğŸ“… ä¿®æ”¹æ—¥æœŸ</button>
          <input class="hidden" type="date" id="d-${t.id}">
          <button class="chip mini" data-edit="time">â° ä¿®æ”¹æ—¶é—´</button>
          <input class="hidden" type="time" id="h-${t.id}">
          <div class="stars" data-id="${t.id}">
            <span class="star" data-v="1">â˜…</span>
            <span class="star" data-v="2">â˜…</span>
            <span class="star" data-v="3">â˜…</span>
            <span class="star" data-v="4">â˜…</span>
            <span class="count">(${t.priority||0})</span>
          </div>
        </div>
      </div>
      <div class="row">
        <button class="btn danger" data-act="del">åˆ é™¤</button>
      </div>
    `;

    // Checkbox complete
    const [ck] = row.getElementsByTagName('input');
    ck.addEventListener('change',()=>{ t.done = ck.checked; save(); render(); });

    // Delete
    row.querySelector('[data-act="del"]').addEventListener('click',()=>{
      tasks = tasks.filter(x=>x.id!==t.id); save(); render();
    });

    // Date edit
    const dateBtn = row.querySelector('[data-edit="date"]');
    const dateInput = row.querySelector(`#d-${t.id}`);
    if(t.when){ dateInput.value = new Date(t.when).toISOString().slice(0,10); }
    dateBtn.addEventListener('click',()=>dateInput.showPicker ? dateInput.showPicker() : dateInput.click());
    dateInput.addEventListener('change',()=>{
      const d = dateInput.value;
      const cur = t.when ? new Date(t.when) : new Date();
      if(d){
        const [y,m,dd] = d.split('-').map(Number);
        cur.setFullYear(y,m-1,dd);
        t.when = cur.toISOString();
        save(); render(); schedule(t);
      }
    });

    // Time edit
    const timeBtn = row.querySelector('[data-edit="time"]');
    const timeInput = row.querySelector(`#h-${t.id}`);
    if(t.when){
      const cur = new Date(t.when);
      timeInput.value = `${String(cur.getHours()).padStart(2,'0')}:${String(cur.getMinutes()).padStart(2,'0')}`;
    }
    timeBtn.addEventListener('click',()=>timeInput.showPicker ? timeInput.showPicker() : timeInput.click());
    timeInput.addEventListener('change',()=>{
      const tm = timeInput.value;
      const cur = t.when ? new Date(t.when) : new Date();
      if(tm){
        const [hh,mm]=tm.split(':').map(Number);
        cur.setHours(hh,mm||0,0,0);
        t.when = cur.toISOString();
        save(); render(); schedule(t);
      }
    });

    // Stars (1â€“4)
    const stars = row.querySelectorAll('.star');
    function paintStars(){
      stars.forEach(s=>{
        const v = Number(s.dataset.v);
        s.classList.toggle('active', v <= (t.priority||0));
      });
      row.querySelector('.stars .count').textContent = `(${t.priority||0})`;
    }
    paintStars();
    stars.forEach(s=>{
      s.addEventListener('click',()=>{
        t.priority = Number(s.dataset.v);
        save(); paintStars(); render();
      });
    });

    return row;
  }

  // ===== scheduling =====
  function schedule(t){
    if(t._timer){ clearTimeout(t._timer); t._timer=null; }
    if(!t.when || t.done) return;
    const ts = new Date(t.when).getTime() - Date.now();
    if(ts <= 0) return;
    t._timer = setTimeout(()=>{
      notify('åˆ°ç‚¹å•¦', t.title);
      // repeat forward
      if(t.repeat && t.repeat!=='none'){
        const d = new Date(t.when);
        switch(t.repeat){
          case 'daily': d.setDate(d.getDate()+1); break;
          case 'weekly': d.setDate(d.getDate()+7); break;
          case 'monthly': d.setMonth(d.getMonth()+1); break;
          case 'yearly': d.setFullYear(d.getFullYear()+1); break;
          case 'custom': d.setDate(d.getDate()+3); break;
        }
        t.when = d.toISOString(); save(); render(); schedule(t);
      }
    }, ts);
  }

  // ===== init =====
  (function initPickers(){
    const now = new Date();
    dateEl.value = now.toISOString().slice(0,10);
    now.setMinutes(now.getMinutes()+30-now.getMinutes()%30,0,0);
    timeEl.value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  })();

  // load theme + tasks
  tasks.forEach(schedule);
  render();
})();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>æ¸…å•Plus</title>
<meta name="theme-color" content="#121421" />
<style>
:root{
  --bg:#0f1220;--panel:#171a2b;--muted:#1f2440;--line:rgba(255,255,255,.08);
  --text:#eaf0ff;--sub:#9aa3c7;--brand:#5a82ff;--accent:#22cda7;--danger:#ff5d5d;--warn:#ffb545;
}
[data-theme="light"]{
  --bg:#f6f7ff;--panel:#ffffff;--muted:#eef1fb;--line:rgba(0,0,0,.08);
  --text:#101426;--sub:#657095;--brand:#345dff;--accent:#17b892;--danger:#d43a3a;--warn:#e39b2c;
}
*{box-sizing:border-box;font-family:-apple-system,Segoe UI,Roboto,"PingFang SC","Microsoft YaHei",sans-serif}
body{margin:0;background:var(--bg);color:var(--text);min-height:100dvh;display:flex;flex-direction:column}
button,input,select{font:inherit;color:inherit}
a{color:var(--brand);text-decoration:none}

/* header */
header{display:flex;align-items:center;gap:10px;padding:12px 14px;background:var(--panel);position:sticky;top:0;z-index:10}
.logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--brand),#82a0ff)}
.title{font-weight:800;font-size:18px}
.space{flex:1}
.iconbtn{width:36px;height:36px;display:grid;place-items:center;border:0;border-radius:10px;background:var(--muted);cursor:pointer}
.iconbtn:active{transform:scale(.98)}

/* layout */
main{flex:1;display:flex;gap:12px;overflow:hidden;padding:10px}
@media (max-width:880px){main{flex-direction:column}}
.sidebar{width:124px;background:var(--panel);padding:10px;border-radius:12px;overflow:auto}
@media (max-width:880px){.sidebar{width:auto;display:flex;gap:8px;overflow:auto}}
.sidebar h4{margin:6px 6px 4px;font-size:12px;color:var(--sub)}
.navbtn{padding:8px 10px;border-radius:10px;background:transparent;border:1px solid var(--line);text-align:left;cursor:pointer;font-size:14px}
.navbtn.on{background:var(--muted);border-color:transparent;font-weight:700}
.counter{float:right;color:var(--sub);margin-left:8px}

.content{flex:1;display:flex;flex-direction:column;gap:10px;min-width:0}

/* stats & quick chips */
.stats{display:flex;gap:8px;flex-wrap:wrap}
.stat{padding:6px 10px;border-radius:999px;background:var(--muted);font-size:12px}
.stat.warn{background:rgba(255,181,69,.15);color:var(--warn)}
.stat.ok{background:rgba(34,205,167,.15);color:var(--accent)}

.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{padding:6px 12px;border-radius:999px;background:var(--muted);cursor:pointer;font-size:13px;white-space:nowrap}
.chip.on{background:var(--brand);color:#fff}

/* task composer */
.composer{display:grid;gap:8px;background:var(--panel);padding:10px;border-radius:12px;
  grid-template-columns:1fr minmax(110px,140px) minmax(90px,110px) minmax(110px,130px) auto}
@media (max-width:680px){
 .composer{grid-template-columns:1fr 1fr 1fr auto}
 .hide-sm{display:none}
}
.composer input, .composer select{padding:10px;border-radius:10px;border:1px solid var(--line);background:var(--muted)}
.addBtn{padding:0 16px;border:0;border-radius:10px;background:var(--brand);color:#fff;font-weight:800}

/* task list */
.tasks{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;min-height:160px}
.task{background:var(--panel);padding:10px;border-radius:12px;display:flex;justify-content:space-between;gap:6px;align-items:center}
.task.done .title{text-decoration:line-through;opacity:.65}
.title{font-weight:700}
.meta{font-size:12px;color:var(--sub)}
.actions{display:flex;gap:6px}
.btn-mini{padding:6px 10px;border:0;border-radius:8px;font-size:12px;cursor:pointer}
.complete{background:var(--accent);color:#fff}
.delete{background:var(--danger);color:#fff}
.important{background:var(--warn);color:#222}
.tag{padding:2px 8px;border-radius:999px;background:var(--muted);font-size:11px;margin-left:6px}

/* settings modal */
.modalMask{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:flex-end;justify-content:center;z-index:20}
.modal{width:100%;max-width:520px;background:var(--panel);border-radius:16px 16px 0 0;padding:14px 14px 18px}
.modal h3{margin:2px 0 12px}
.settingRow{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:var(--muted);margin-bottom:8px}
.switch{position:relative;width:48px;height:28px;background:#7d86a8;border-radius:999px;cursor:pointer}
.switch i{position:absolute;top:3px;left:3px;width:22px;height:22px;background:#fff;border-radius:50%;transition:.2s}
.switch.on{background:var(--brand)}
.switch.on i{left:23px}
.rowBtns{display:flex;gap:8px}
.rowBtns button{border:0;padding:8px 10px;border-radius:8px;background:var(--brand);color:#fff}
.closeLine{display:flex;justify-content:center;margin-top:6px}
.closeDot{width:46px;height:4px;border-radius:4px;background:var(--line)}
</style>
</head>
<body>
  <header>
    <div class="logo" aria-hidden="true"></div>
    <div class="title">æ¸…å•Plus</div>
    <div class="space"></div>
    <button class="iconbtn" id="themeBtn" title="æ·±æµ…æ¨¡å¼">ğŸŒ™</button>
    <button class="iconbtn" id="settingsBtn" title="è®¾ç½®">âš™ï¸</button>
  </header>

  <main>
    <!-- left -->
    <aside class="sidebar" id="nav">
      <div style="display:flex;flex-direction:column;gap:6px;">
        <h4>è§†å›¾</h4>
        <button class="navbtn on" data-filter="all">å…¨éƒ¨ <span class="counter" id="count-all">0</span></button>
        <button class="navbtn" data-filter="today">ä»Šå¤© <span class="counter" id="count-today">0</span></button>
        <button class="navbtn" data-filter="important">é‡è¦ <span class="counter" id="count-important">0</span></button>
        <button class="navbtn" data-filter="done">å·²å®Œæˆ</button>
        <button class="navbtn" data-filter="undone">æœªå®Œæˆ</button>
        <h4>åˆ†ç±»</h4>
        <button class="navbtn" data-cat="å­¦ä¹ ">å­¦ä¹ </button>
        <button class="navbtn" data-cat="å·¥ä½œ">å·¥ä½œ</button>
        <button class="navbtn" data-cat="ç”Ÿæ´»">ç”Ÿæ´»</button>
      </div>
    </aside>

    <!-- right -->
    <section class="content">
      <!-- quick stats -->
      <div class="stats">
        <div class="stat" id="stat-today">ä»Šæ—¥ï¼š0</div>
        <div class="stat warn" id="stat-overdue">è¶…æœŸï¼š0</div>
        <div class="stat ok" id="stat-done">å·²å®Œæˆï¼š0</div>
      </div>

      <!-- quick chips -->
      <div class="chips" id="quickChips">
        <div class="chip" data-chip="today">ä»Šå¤©</div>
        <div class="chip" data-chip="tomorrow">æ˜å¤©</div>
        <div class="chip" data-chip="week">æœ¬å‘¨</div>
        <div class="chip" data-chip-weekday="1">å‘¨ä¸€</div>
        <div class="chip" data-chip-weekday="2">å‘¨äºŒ</div>
        <div class="chip" data-chip-weekday="3">å‘¨ä¸‰</div>
        <div class="chip" data-chip-weekday="4">å‘¨å››</div>
        <div class="chip" data-chip-weekday="5">å‘¨äº”</div>
        <div class="chip" data-chip-weekday="6">å‘¨å…­</div>
        <div class="chip" data-chip-weekday="0">å‘¨æ—¥</div>
      </div>

      <!-- composer -->
      <div class="composer">
        <input id="taskInput" type="text" placeholder="è¾“å…¥ä»»åŠ¡ï¼ˆå¦‚ï¼šå®Œæˆä½œä¸š / ä¹°èœï¼‰"/>
        <input id="dateInput" type="date" class="hide-sm"/>
        <input id="timeInput" type="time"/>
        <select id="catInput">
          <option value="å­¦ä¹ ">å­¦ä¹ </option>
          <option value="å·¥ä½œ">å·¥ä½œ</option>
          <option value="ç”Ÿæ´»">ç”Ÿæ´»</option>
        </select>
        <button class="addBtn" id="addBtn">æ·»åŠ </button>
      </div>

      <!-- repeat -->
      <div class="chips" id="repeatChips">
        <div class="chip on" data-repeat="none">ä¸é‡å¤</div>
        <div class="chip" data-repeat="daily">æ¯å¤©</div>
        <div class="chip" data-repeat="weekly">æ¯å‘¨</div>
        <div class="chip" data-repeat="monthly">æ¯æœˆ</div>
        <div class="chip" data-repeat="yearly">æ¯å¹´</div>
      </div>

      <!-- tasks -->
      <div class="tasks" id="taskList"></div>
    </section>
  </main>

  <!-- Settings Modal -->
  <div class="modalMask" id="modalMask" role="dialog" aria-modal="true" aria-label="è®¾ç½®">
    <div class="modal">
      <h3>åº”ç”¨è®¾ç½®</h3>

      <div class="settingRow">
        <div>
          <div style="font-weight:700">æ·±æµ…æ¨¡å¼</div>
          <div class="meta">è‡ªåŠ¨ä¿å­˜ä¸»é¢˜åˆ°æœ¬åœ°</div>
        </div>
        <div class="switch" id="themeSwitch"><i></i></div>
      </div>

      <div class="settingRow">
        <div>
          <div style="font-weight:700">é»˜è®¤åˆ†ç±»</div>
          <div class="meta">æ–°å¢ä»»åŠ¡çš„é»˜è®¤åˆ†ç±»</div>
        </div>
        <select id="defaultCat">
          <option value="å­¦ä¹ ">å­¦ä¹ </option>
          <option value="å·¥ä½œ">å·¥ä½œ</option>
          <option value="ç”Ÿæ´»">ç”Ÿæ´»</option>
        </select>
      </div>

      <div class="settingRow">
        <div>
          <div style="font-weight:700">é»˜è®¤é‡å¤</div>
          <div class="meta">æ–°å¢ä»»åŠ¡é»˜è®¤çš„é‡å¤è§„åˆ™</div>
        </div>
        <select id="defaultRepeat">
          <option value="none">ä¸é‡å¤</option>
          <option value="daily">æ¯å¤©</option>
          <option value="weekly">æ¯å‘¨</option>
          <option value="monthly">æ¯æœˆ</option>
          <option value="yearly">æ¯å¹´</option>
        </select>
      </div>

      <div class="settingRow">
        <div>
          <div style="font-weight:700">æ•°æ®</div>
          <div class="meta">å¯¼å‡º / å¯¼å…¥ / æ¸…ç©ºï¼ˆä¸å¯æ’¤é”€ï¼‰</div>
        </div>
        <div class="rowBtns">
          <button id="btnExport">å¯¼å‡º</button>
          <button id="btnImport">å¯¼å…¥</button>
          <button id="btnClear" style="background:var(--danger)">æ¸…ç©º</button>
        </div>
      </div>

      <div class="closeLine"><div class="closeDot"></div></div>
    </div>
  </div>

<script>
const $=s=>document.querySelector(s);
const $$=s=>document.querySelectorAll(s);

let tasks=JSON.parse(localStorage.getItem("qd.tasks")||"[]");
let appCfg=JSON.parse(localStorage.getItem("qd.cfg")||'{"theme":"dark","defaultCat":"å­¦ä¹ ","defaultRepeat":"none"}');

let filter="all", activeCat=null, repeat=appCfg.defaultRepeat;

/* ===== helpers ===== */
const todayStr=()=>new Date().toISOString().slice(0,10);
const isSameWeek=(d)=>{const x=new Date(d),t=new Date(),s=new Date(t);s.setDate(t.getDate()-t.getDay());s.setHours(0,0,0,0);const e=new Date(s);e.setDate(s.getDate()+7);return x>=s&&x<e};
const weekday=(d)=>new Date(d).getDay();

/* ===== storage ===== */
function saveCfg(){localStorage.setItem("qd.cfg",JSON.stringify(appCfg))}
function save(){localStorage.setItem("qd.tasks",JSON.stringify(tasks));render();}

/* ===== UI state ===== */
function applyTheme(){
  const isLight = appCfg.theme==="light";
  document.body.setAttribute("data-theme", isLight?"light":"dark");
  $("#themeBtn").textContent=isLight?"â˜€ï¸":"ğŸŒ™";
  $("#themeSwitch").classList.toggle("on", isLight);
}
applyTheme();

/* ===== adding ===== */
function addTask(){
  const title=$("#taskInput").value.trim();
  if(!title){ $("#taskInput").focus(); return; }
  const date=$("#dateInput").value || todayStr();
  const time=$("#timeInput").value || "09:00";
  const cat=$("#catInput").value;
  tasks.push({
    id:Date.now(), title, date, time, cat,
    repeat, done:false, important:false
  });
  $("#taskInput").value="";
  save();
}
$("#addBtn").onclick=addTask;
$("#taskInput").addEventListener('keydown',e=>{if(e.key==="Enter") addTask()});

/* ===== render ===== */
function render(){
  // filter
  let list=tasks.filter(t=>{
    if(activeCat && t.cat!==activeCat) return false;
    if(filter==="today") return t.date===todayStr();
    if(filter==="important") return t.important;
    if(filter==="done") return t.done;
    if(filter==="undone") return !t.done;
    return true;
  });

  // sort by date+time
  list.sort((a,b)=> (a.date+a.time).localeCompare(b.date+b.time));

  // build items
  const wrap=$("#taskList");
  wrap.innerHTML="";
  list.forEach(t=>{
    const div=document.createElement("div");
    div.className="task"+(t.done?" done":"");
    div.innerHTML=`
      <div style="min-width:0">
        <div class="title">${escapeHTML(t.title)}
          ${t.important?'<span class="tag" style="background:rgba(255,181,69,.2);color:var(--warn)">é‡è¦</span>':''}
          ${overdue(t)?'<span class="tag" style="background:rgba(255,93,93,.2);color:var(--danger)">è¶…æœŸ</span>':''}
        </div>
        <div class="meta">${t.date} ${t.time} Â· ${t.cat} Â· ${labelRepeat(t.repeat)}</div>
      </div>
      <div class="actions">
        <button class="btn-mini important">${t.important?"å–æ¶ˆé‡è¦":"æ ‡ä¸ºé‡è¦"}</button>
        <button class="btn-mini complete">${t.done?"æ’¤é”€":"å®Œæˆ"}</button>
        <button class="btn-mini delete">åˆ é™¤</button>
      </div>`;
    div.querySelector(".complete").onclick=()=>{t.done=!t.done;save();}
    div.querySelector(".delete").onclick=()=>{tasks=tasks.filter(x=>x.id!==t.id);save();}
    div.querySelector(".important").onclick=()=>{t.important=!t.important;save();}
    wrap.appendChild(div);
  });

  // counters + stats
  $("#count-all").textContent=tasks.length;
  $("#count-today").textContent=tasks.filter(t=>t.date===todayStr()).length;
  $("#count-important").textContent=tasks.filter(t=>t.important).length;

  const todayCnt=tasks.filter(t=>t.date===todayStr() && !t.done).length;
  const overdueCnt=tasks.filter(t=>overdue(t) && !t.done).length;
  const doneCnt=tasks.filter(t=>t.done).length;
  $("#stat-today").textContent=`ä»Šæ—¥ï¼š${todayCnt}`;
  $("#stat-overdue").textContent=`è¶…æœŸï¼š${overdueCnt}`;
  $("#stat-done").textContent=`å·²å®Œæˆï¼š${doneCnt}`;
}
function labelRepeat(r){return r==="none"?"ä¸é‡å¤":r==="daily"?"æ¯å¤©":r==="weekly"?"æ¯å‘¨":r==="monthly"?"æ¯æœˆ":"æ¯å¹´"}
function overdue(t){
  const now=new Date();const dt=new Date(`${t.date}T${t.time||"23:59"}:00`);
  return !t.done && dt<now;
}
function escapeHTML(s){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

/* ===== filters ===== */
$$(".navbtn").forEach(btn=>{
  btn.onclick=()=>{
    $$(".navbtn").forEach(b=>b.classList.remove("on"));
    btn.classList.add("on");
    filter=btn.dataset.filter||"all";
    activeCat=btn.dataset.cat||null;
    render();
  };
});
$("#quickChips").addEventListener("click",(e)=>{
  const chip=e.target.closest(".chip"); if(!chip) return;
  $$("#quickChips .chip").forEach(c=>c.classList.remove("on"));
  chip.classList.add("on");
  const ds=chip.dataset;
  if(ds.chip==="today"){filter="today";activeCat=null;[...$("#nav").querySelectorAll(".navbtn")].forEach(b=>b.classList.remove("on"));}
  else if(ds.chip==="tomorrow"){filter="all";activeCat=null;dateSet(new Date(Date.now()+86400000));}
  else if(ds.chip==="week"){filter="all";activeCat=null;/* visual only */ }
  else if(ds.chipWeekday!==undefined){
    filter="all"; activeCat=null;
    // jump composer date to next selected weekday
    const want=+ds.chipWeekday, d=new Date(); let diff=(want-d.getDay()+7)%7; if(diff===0) diff=7;
    d.setDate(d.getDate()+diff); dateSet(d);
  }
  render();
});
function dateSet(d){
  $("#dateInput").value=d.toISOString().slice(0,10);
}

/* repeat chips */
$("#repeatChips").addEventListener("click",(e)=>{
  const c=e.target.closest(".chip");if(!c) return;
  $$("#repeatChips .chip").forEach(x=>x.classList.remove("on"));
  c.classList.add("on");
  repeat=c.dataset.repeat;
});

/* ===== settings ===== */
const modal=$("#modalMask");
$("#settingsBtn").onclick=()=>{openSettings();}
modal.addEventListener("click",(e)=>{ if(e.target===modal) modal.style.display="none"; });

function openSettings(){
  $("#defaultCat").value=appCfg.defaultCat;
  $("#defaultRepeat").value=appCfg.defaultRepeat;
  const isLight=appCfg.theme==="light";
  $("#themeSwitch").classList.toggle("on",isLight);
  modal.style.display="flex";
}

$("#themeBtn").onclick=()=>{
  appCfg.theme = (appCfg.theme==="light"?"dark":"light");
  saveCfg(); applyTheme();
};
$("#themeSwitch").onclick=()=>{
  appCfg.theme = $("#themeSwitch").classList.toggle("on") ? "light" : "dark";
  saveCfg(); applyTheme();
};
$("#defaultCat").onchange=e=>{appCfg.defaultCat=e.target.value; $("#catInput").value=e.target.value; saveCfg();}
$("#defaultRepeat").onchange=e=>{appCfg.defaultRepeat=e.target.value; repeat=e.target.value; saveCfg();}

/* data ops in settings */
$("#btnExport").onclick=()=>{
  const blob=new Blob([JSON.stringify(tasks)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="qingdan-data.json"; a.click();
  URL.revokeObjectURL(url);
};
$("#btnImport").onclick=()=>{
  const inp=document.createElement("input"); inp.type="file"; inp.accept="application/json";
  inp.onchange=ev=>{
    const f=ev.target.files[0]; if(!f) return;
    const fr=new FileReader();
    fr.onload=()=>{ try{ tasks=JSON.parse(fr.result||"[]"); save(); modal.style.display="none"; }catch(e){ alert("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®"); } };
    fr.readAsText(f);
  };
  inp.click();
};
$("#btnClear").onclick=()=>{ if(confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€")){ tasks=[]; save(); modal.style.display="none"; } };

/* defaults */
$("#catInput").value=appCfg.defaultCat;
$(`#repeatChips .chip[data-repeat="${appCfg.defaultRepeat}"]`)?.classList.add("on");

/* init */
if(!$("#dateInput").value) $("#dateInput").value=todayStr();
if(!$("#timeInput").value) $("#timeInput").value="09:00";
render();
</script>
</body>
</html>

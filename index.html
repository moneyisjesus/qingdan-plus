<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>清单Plus</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0f1226" />
  <style>
    :root{
      --bg:#0f1226;--panel:#1a1d36;--panel-2:#2a2f55;--text:#ffffff;--muted:#a7abcf;--brand:#5a5ee6;--border:#2b2e49;--ok:#21c49d;--warn:#ffb02e;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,"Segoe UI","Microsoft YaHei",Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans","PingFang SC","Hiragino Sans GB",sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .app{display:flex;height:100vh;max-width:1200px;margin:0 auto}

    /* Sidebar */
    .sidebar{
      width:230px;min-width:200px;background:var(--panel);border-right:1px solid var(--border);
      padding:18px 14px;display:flex;flex-direction:column;gap:12px
    }
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{
      width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#6b6fe9,#3b3fbb);display:grid;place-items:center;
      font-weight:800
    }
    .brand .name{font-size:18px;font-weight:700}
    .nav{margin-top:8px;display:flex;flex-direction:column;gap:6px}
    .nav button{
      width:100%;text-align:left;border:none;border-radius:10px;padding:10px 12px;background:transparent;
      color:var(--text);cursor:pointer;display:flex;justify-content:space-between;align-items:center;gap:10px
    }
    .nav button.active{background:var(--panel-2)}
    .nav .count{opacity:.65;font-size:12px;background:#ffffff14;padding:2px 7px;border-radius:999px}
    .spacer{flex:1}
    .foot-actions{display:flex;gap:8px}
    .foot-actions button{
      flex:1;border:none;background:var(--panel-2);color:#fff;border-radius:8px;padding:8px;cursor:pointer
    }

    /* Main area */
    .main{flex:1;display:flex;flex-direction:column}
    .topbar{
      display:flex;align-items:center;gap:10px; padding:14px;border-bottom:1px solid var(--border)
    }
    .title{font-size:20px;font-weight:700;margin-right:auto}
    .addbar{
      flex:1;display:flex;gap:10px;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:8px 10px
    }
    .addbar input{
      flex:1;border:none;background:transparent;color:var(--text);outline:none;font-size:14px
    }
    .add-btn{
      border:none;background:var(--brand);color:#fff;border-radius:8px;padding:8px 14px;cursor:pointer;white-space:nowrap
    }

    .chips{display:flex;gap:8px;flex-wrap:wrap;padding:10px 14px;border-bottom:1px solid var(--border)}
    .chip{
      border:none;background:var(--panel-2);color:var(--text);padding:6px 10px;border-radius:999px;cursor:pointer;font-size:13px
    }

    .toolbar{
      padding:8px 14px;display:flex;gap:10px;align-items:center;border-bottom:1px solid var(--border);color:var(--muted);font-size:12px
    }
    .toolbar input, .toolbar select{
      background:var(--panel);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:6px 8px;font-size:12px
    }

    .list{flex:1;overflow:auto;padding:10px 8px}
    .task{
      display:flex;align-items:flex-start;gap:10px;background:var(--panel);border:1px solid var(--border);border-radius:12px;
      padding:10px 12px;margin:8px 6px
    }
    .task .left{display:flex;align-items:flex-start;gap:10px;flex:1}
    .check{
      width:20px;height:20px;border-radius:50%;border:2px solid var(--muted);display:grid;place-items:center;cursor:pointer;flex-shrink:0
    }
    .check.done{border-color:var(--ok);background:var(--ok)}
    .titleline{display:flex;align-items:center;gap:8px}
    .task-title{font-weight:600}
    .meta{color:var(--muted);font-size:12px;margin-top:4px;display:flex;gap:10px;flex-wrap:wrap}
    .pill{background:#ffffff14;border-radius:999px;padding:2px 8px}
    .right{display:flex;gap:6px}
    .iconbtn{
      border:none;background:var(--panel-2);color:#fff;border-radius:8px;padding:6px 8px;cursor:pointer
    }
    .iconbtn.warn{background:#b84a35}
    .empty{
      text-align:center;opacity:.6;margin-top:40px
    }

    /* Mobile-first tweaks */
    @media (max-width: 820px){
      .app{flex-direction:column}
      .sidebar{
        width:100%;min-width:auto;flex-direction:row;align-items:center;gap:8px;padding:10px;border-right:none;border-bottom:1px solid var(--border)
      }
      .nav{flex-direction:row;gap:8px;overflow:auto}
      .nav button{padding:8px 10px}
      .foot-actions{display:none}
      .title{font-size:18px}
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">清</div>
        <div class="name">清单Plus</div>
      </div>

      <div class="nav" id="nav">
        <button data-list="myday" class="active">我的一天 <span class="count" id="count-myday">0</span></button>
        <button data-list="important">重要 <span class="count" id="count-important">0</span></button>
        <button data-list="planned">计划 <span class="count" id="count-planned">0</span></button>
        <button data-list="all">任务 <span class="count" id="count-all">0</span></button>
      </div>

      <div class="spacer"></div>

      <div class="foot-actions">
        <button id="exportBtn">导出</button>
        <button id="importBtn">导入</button>
        <button id="settingsBtn">设置</button>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="topbar">
        <div class="title" id="title">我的一天</div>

        <div class="addbar">
          <input id="taskInput" type="text" placeholder="添加任务…" />
        </div>
        <button class="add-btn" id="addBtn">添加</button>
      </div>

      <div class="chips">
        <button class="chip" data-chip="today">今天</button>
        <button class="chip" data-chip="tomorrow">明天</button>
        <button class="chip" data-chip="nextmon">下周一</button>
        <button class="chip" data-chip="9am">上午9:00</button>
        <button class="chip" data-chip="3pm">下午3:00</button>
      </div>

      <div class="toolbar">
        <span>日期</span>
        <input type="date" id="datePicker">
        <span>时间</span>
        <input type="time" id="timePicker">
        <span>重复</span>
        <select id="repeatSel">
          <option value="none">不重复</option>
          <option value="daily">每天</option>
          <option value="weekly">每周</option>
          <option value="monthly">每月</option>
        </select>
      </div>

      <div class="list" id="list">
        <p class="empty">没有任务</p>
      </div>
    </main>
  </div>

  <script>
    // ---------- Utilities ----------
    const $ = (s, r = document) => r.querySelector(s);
    const $$ = (s, r = document) => [...r.querySelectorAll(s)];

    const fmtDate = (d) => {
      if(!d) return "";
      const dt = (d instanceof Date) ? d : new Date(d);
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,'0');
      const da = String(dt.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    };
    const fmtTime = (t) => t || "";
    const today = () => new Date(new Date().setHours(0,0,0,0));
    const addDays = (date, n) => new Date(date.getTime() + n*86400000);
    const getNextMonday = () => {
      const d = today();
      const day = d.getDay() || 7; // Sun=0 -> 7
      const add = (8 - day);
      return addDays(d, add);
    };

    // ---------- State ----------
    const storeKey = "qingdan_plus_tasks_v1";
    let tasks = JSON.parse(localStorage.getItem(storeKey) || "[]");
    let currentList = localStorage.getItem("qingdan_plus_current") || "myday";

    // Quick selections buffer
    let quickDue = null;  // string yyyy-mm-dd
    let quickTime = null; // string HH:mm
    let quickRepeat = "none";

    // ---------- Elements ----------
    const nav = $("#nav");
    const title = $("#title");
    const listEl = $("#list");
    const taskInput = $("#taskInput");
    const addBtn = $("#addBtn");

    const datePicker = $("#datePicker");
    const timePicker = $("#timePicker");
    const repeatSel = $("#repeatSel");

    // ---------- Navigation ----------
    nav.addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-list]");
      if(!btn) return;
      $$(".nav button").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      currentList = btn.dataset.list;
      localStorage.setItem("qingdan_plus_current", currentList);
      title.textContent = btn.textContent.replace(/\s+\d+$/, "").trim();
      render();
    });

    // ---------- Quick chips ----------
    $$(".chip").forEach(chip=>{
      chip.addEventListener("click", ()=>{
        switch(chip.dataset.chip){
          case "today":
            quickDue = fmtDate(today());
            datePicker.value = quickDue;
            break;
          case "tomorrow":
            quickDue = fmtDate(addDays(today(),1));
            datePicker.value = quickDue;
            break;
          case "nextmon":
            quickDue = fmtDate(getNextMonday());
            datePicker.value = quickDue;
            break;
          case "9am":
            quickTime = "09:00";
            timePicker.value = "09:00";
            break;
          case "3pm":
            quickTime = "15:00";
            timePicker.value = "15:00";
            break;
        }
      });
    });

    // When picker changes, sync buffer
    datePicker.addEventListener("change", ()=> quickDue = datePicker.value || null);
    timePicker.addEventListener("change", ()=> quickTime = timePicker.value || null);
    repeatSel.addEventListener("change", ()=> quickRepeat = repeatSel.value);

    // ---------- Add task ----------
    const addTask = ()=>{
      const title = taskInput.value.trim();
      if(!title) return;

      const t = {
        id: crypto.randomUUID(),
        title,
        done:false,
        important:false,
        createdAt: Date.now(),
        due: quickDue,   // yyyy-mm-dd
        time: quickTime, // HH:mm
        repeat: quickRepeat, // none/daily/weekly/monthly
        myDay: (currentList==="myday"), // mark when adding in My Day
      };

      // If adding in “重要”
      if(currentList==="important") t.important = true;

      tasks.push(t);
      persist();
      taskInput.value="";
      render();
    };
    addBtn.addEventListener("click", addTask);
    taskInput.addEventListener("keydown", (e)=>{
      if(e.key==="Enter") addTask();
    });

    // ---------- Render ----------
    function matchesCurrentList(t){
      if(currentList==="all") return !t.done;
      if(currentList==="important") return t.important && !t.done;
      if(currentList==="planned") return t.due && !t.done;
      // 我的⼀天: 1) 显式加到 myDay 或 2) 今天到期，且未完成
      if(currentList==="myday"){
        const isToday = (t.due && t.due === fmtDate(today()));
        return (t.myDay || isToday) && !t.done;
      }
      return !t.done;
    }

    function render(){
      // Counts
      const counts = {
        myday: tasks.filter(t => (t.myDay || (t.due===fmtDate(today()))) && !t.done).length,
        important: tasks.filter(t => t.important && !t.done).length,
        planned: tasks.filter(t => t.due && !t.done).length,
        all: tasks.filter(t => !t.done).length,
      };
      $("#count-myday").textContent = counts.myday;
      $("#count-important").textContent = counts.important;
      $("#count-planned").textContent = counts.planned;
      $("#count-all").textContent = counts.all;

      // List
      const filtered = tasks.filter(matchesCurrentList).sort((a,b)=>a.done-b.done || (a.due||"").localeCompare(b.due||"") || b.createdAt - a.createdAt);
      listEl.innerHTML = "";
      if(filtered.length===0){
        listEl.innerHTML = `<p class="empty">没有任务</p>`;
        return;
      }

      for(const t of filtered){
        const li = document.createElement("div");
        li.className = "task";

        const left = document.createElement("div");
        left.className = "left";

        const chk = document.createElement("div");
        chk.className = "check" + (t.done ? " done" : "");
        chk.title = t.done ? "标记为未完成" : "标记为完成";
        chk.addEventListener("click", ()=>{
          t.done = !t.done;
          // simple repeat handling: when marking done and repeat set, create next
          if(t.done && t.repeat && t.repeat!=="none" && t.due){
            const cur = new Date(t.due);
            let next = new Date(cur);
            if(t.repeat==="daily") next = addDays(cur,1);
            if(t.repeat==="weekly") next = addDays(cur,7);
            if(t.repeat==="monthly"){ next = new Date(cur); next.setMonth(cur.getMonth()+1); }
            tasks.push({
              ...t,
              id: crypto.randomUUID(),
              done:false,
              createdAt: Date.now(),
              due: fmtDate(next),
            });
          }
          persist(); render();
        });

        const body = document.createElement("div");
        body.style.flex = "1";

        const titleline = document.createElement("div");
        titleline.className = "titleline";
        const span = document.createElement("span");
        span.className = "task-title";
        span.textContent = t.title;
        if(t.done){ span.style.textDecoration = "line-through"; span.style.opacity = ".6"; }
        titleline.appendChild(span);

        const meta = document.createElement("div");
        meta.className = "meta";
        if(t.due) meta.innerHTML += `<span class="pill">到期 ${t.due}${t.time?(" "+t.time):""}</span>`;
        if(t.repeat && t.repeat!=="none"){
          const map = {daily:"每天",weekly:"每周",monthly:"每月"};
          meta.innerHTML += `<span class="pill">${map[t.repeat]||t.repeat}</span>`;
        }
        if(t.important) meta.innerHTML += `<span class="pill">⭐ 重要</span>`;
        if(t.myDay) meta.innerHTML += `<span class="pill">☀ 我的⼀天</span>`;

        body.appendChild(titleline);
        body.appendChild(meta);

        left.appendChild(chk);
        left.appendChild(body);

        const right = document.createElement("div");
        right.className = "right";

        const star = document.createElement("button");
        star.className = "iconbtn";
        star.textContent = t.important ? "⭐" : "☆";
        star.title = t.important ? "取消重要" : "标记重要";
        star.addEventListener("click",()=>{
          t.important = !t.important; persist(); render();
        });

        const sun = document.createElement("button");
        sun.className = "iconbtn";
        sun.textContent = t.myDay ? "☀" : "◯";
        sun.title = t.myDay ? "从我的一天移除" : "加入我的一天";
        sun.addEventListener("click",()=>{
          t.myDay = !t.myDay; persist(); render();
        });

        const del = document.createElement("button");
        del.className = "iconbtn warn";
        del.textContent = "删除";
        del.addEventListener("click",()=>{
          tasks = tasks.filter(x => x.id!==t.id);
          persist(); render();
        });

        right.appendChild(star);
        right.appendChild(sun);
        right.appendChild(del);

        li.appendChild(left);
        li.appendChild(right);
        listEl.appendChild(li);
      }
    }

    function persist(){ localStorage.setItem(storeKey, JSON.stringify(tasks)); }

    // ---------- Import/Export (simple JSON file) ----------
    $("#exportBtn")?.addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify(tasks,null,2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "清单Plus-导出.json";
      a.click();
    });
    $("#importBtn")?.addEventListener("click", ()=>{
      const inp = document.createElement("input");
      inp.type="file"; inp.accept="application/json";
      inp.onchange = ()=> {
        const f = inp.files?.[0]; if(!f) return;
        const rd = new FileReader();
        rd.onload = ()=> {
          try{
            const data = JSON.parse(rd.result);
            if(Array.isArray(data)){ tasks = data; persist(); render(); }
            else alert("文件格式不正确");
          }catch{ alert("导入失败"); }
        };
        rd.readAsText(f);
      };
      inp.click();
    });

    // ---------- Init ----------
    // restore quick pickers to empty
    quickDue = null; quickTime = null; quickRepeat = "none";
    datePicker.value = ""; timePicker.value = ""; repeatSel.value = "none";

    // activate nav according to last selection
    $$(".nav button").forEach(b=>{
      b.classList.toggle("active", b.dataset.list === currentList);
    });
    title.textContent = {myday:"我的一天",important:"重要",planned:"计划",all:"任务"}[currentList] || "我的一天";

    render();
  </script>
</body>
</html>
